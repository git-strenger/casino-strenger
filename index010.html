  <!doctype html>
  <html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Strenger Casino Roulette - Premium Edition</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

      <style>
        :root{
          --bg-body: #0b0d10;       
          --bg-panel: #131519;      
          --bg-element: #1c1f24;    
          --accent: #f59e0b;        
          --accent-hover: #d97706;
          --text-main: #ffffff;
          --text-muted: #9ca3af;
          
          --gold-1: #bf953f;
          --gold-2: #fcf6ba;
          --gold-3: #b38728;
          
          --gap: 6px;
          --radius: 12px;
        }

        *{box-sizing:border-box}
        body {
          margin: 0; padding: 0;
          font-family: 'Inter', sans-serif;
          background-color: var(--bg-body);
          color: var(--text-main);
          min-height: 100vh;
          display: flex; flex-direction: column; overflow-y: auto;
          overflow-x: hidden;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0b0d10; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }

        /* HEADER */
        header {
          height: 70px;
          border-bottom: 1px solid rgba(255,255,255,0.05);
          display: grid; 
          grid-template-columns: 320px 1fr 320px;
          gap: 20px;
          align-items: center;
          padding: 0 20px; background: var(--bg-panel); flex: 0 0 auto; z-index: 500;
          position: relative;
        }
        .brand { display: flex; align-items: center; gap: 12px; justify-self: start; }
        .brand svg { width: 42px; height: 42px; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.5)); }
        .brand-text { display: flex; flex-direction: column; line-height: 1; justify-content: center; }
        .brand-title {
          font-family: 'Cinzel', serif; font-weight: 700; font-size: 18px; letter-spacing: 1px;
          background: linear-gradient(to right, var(--gold-1), var(--gold-2), var(--gold-3));
          -webkit-background-clip: text; background-clip: text; color: transparent; text-transform: uppercase;
        }
        .brand-subtitle {
          font-family: 'Cinzel', serif; font-weight: 400; font-size: 10px; letter-spacing: 3px;
          color: #cfb53b; text-transform: uppercase; margin-top: 3px;
        }
        .user-stats { display: flex; gap: 15px; font-size: 12px; font-weight: 600; align-items: center; justify-self: end; }
        .balance-main {
          display: flex; gap: 12px; align-items: center; 
          justify-self: center;
        }
        .balance-icon { 
          width: 32px; height: 32px; 
          background: linear-gradient(135deg, var(--accent), #ea580c); 
          border-radius: 50%; display: grid; place-items: center; 
          font-size: 16px; box-shadow: 0 2px 8px rgba(245,158,11,0.4);
        }
        .balance-amount { color: var(--gold-2); font-family: monospace; font-size: 20px; font-weight: 700; letter-spacing: 0.5px; }
        .stat-box { 
          background: var(--bg-element); padding: 8px 14px; border-radius: 12px; 
          display: flex; gap: 8px; align-items: center; border: 1px solid rgba(255,255,255,0.05); cursor: pointer;
        }
        .stat-box:hover { background: rgba(255,255,255,0.08); }
        #settingsBtn:hover {
          background: rgba(255,255,255,0.1);
        }
        .stat-box:has(#userAvatar):hover {
          background: rgba(245,158,11,0.1);
          border-color: rgba(245,158,11,0.2);
        }
        #btnConnect:hover {
          background: rgba(34,197,94,0.1);
          border-color: rgba(34,197,94,0.2);
        }
        .money { color: var(--gold-2); font-family: monospace; font-size: 13px;}

        /* LAYOUT */
        .dashboard {
          flex: 1; 
          display: grid; 
          grid-template-columns: 320px 1fr 320px;
          grid-template-rows: 1fr auto;
          gap: 20px; 
          padding: 20px; 
          overflow: visible;
          position: relative;
          z-index: 1;
        }
        .left-column {
          grid-column: 1;
          grid-row: 1;
          overflow: hidden;
        }
        .left-column .panel {
          height: 100%;
        }
        .game-area {
          grid-column: 2;
          grid-row: 1;
          display: flex; 
          flex-direction: column; 
          gap: 20px;
          overflow: visible;
        }
        .right-column {
          grid-column: 3;
          grid-row: 1;
          display: flex;
          flex-direction: column;
          gap: 20px;
          overflow: hidden;
        }
        .right-column .panel {
          flex: 0 0 auto;
        }
        .top-players-full {
          grid-column: 1 / 3;
          grid-row: 2;
          height: 500px;
        }
        .top-players-full .panel-body {
          overflow-y: auto;
        }
        .chat-extended {
          grid-column: 3;
          grid-row: 2;
          height: 500px;
          display: flex;
          flex-direction: column;
        }
        .chat-extended .panel-body {
          flex: 1;
          min-height: 0;
        }
        .panel {
          background: var(--bg-panel); border-radius: 16px; border: 1px solid rgba(255,255,255,0.03);
          display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .panel-head {
          padding: 14px 16px; font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-muted);
          border-bottom: 1px solid rgba(255,255,255,0.03); display: flex; justify-content: space-between;
        }
        .live-indicator {
          color: #ef4444;
          font-size: 8px;
          vertical-align: middle;
          margin-left: 6px;
          animation: livePulse 2s ease-in-out infinite;
          text-shadow: 0 0 10px rgba(239, 68, 68, 0.6);
        }
        .panel-body { flex: 1; overflow-y: auto; padding: 0; }

        /* LEFT: PLAYERS */
        .player-item {
          display: flex; align-items: center; padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.02); font-size: 13px;
          transition: background 0.2s;
        }
        .player-item:hover { background: rgba(255,255,255,0.02); }
        .avatar { 
          width: 36px; height: 36px; border-radius: 12px; 
          margin-right: 12px; display: grid; place-items: center; 
          font-weight: bold; font-size: 14px; 
          box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .p-name { color: #e5e7eb; font-weight: 600; font-size: 13px; } 
        .p-win { color: #cfb53b; font-size: 12px; font-weight: 700; font-family: monospace; text-align: right;}
        
        /* Top Players Section */
        .tabs { display: flex; border-bottom: 1px solid rgba(255,255,255,0.03); border-top: 1px solid rgba(255,255,255,0.03); background: #0f1113; }
        .tab { 
          flex: 1; padding: 12px 8px; text-align: center; font-size: 10px; 
          font-weight: 700; text-transform: uppercase; cursor: pointer; 
          color: var(--text-muted); border-bottom: 2px solid transparent; transition: all 0.2s;
        }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        .tab:hover { color: #e5e7eb; }
        .leaderboard { padding: 10px; font-size: 11px; }
        .leaderboard-header { display: grid; grid-template-columns: 3fr 2fr 1fr 2fr 2fr 2fr; padding: 8px 10px; font-size: 9px; color: var(--text-muted); font-weight: 700; text-transform: uppercase; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .leaderboard-row { display: grid; grid-template-columns: 3fr 2fr 1fr 2fr 2fr 2fr; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.02); transition: all 0.3s; align-items: center; border-radius: 8px; animation: rowFadeIn 0.4s ease-out; }
        .leaderboard-row:hover { background: rgba(255,255,255,0.02); transform: translateX(2px); }
        @keyframes rowFadeIn {
          0% { opacity: 0; transform: translateY(-10px); }
          100% { opacity: 1; transform: translateY(0); }
        }
        @keyframes livePulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.3; }
        }
        #liveDot {
          animation: livePulse 1.5s ease-in-out infinite;
        }
        .lb-user { color: #e5e7eb; }
        .lb-profit { color: #22c55e; font-weight: 700; font-family: monospace; }
        .big-win-row {
          background: linear-gradient(90deg, rgba(34,197,94,0.1) 0%, transparent 100%) !important;
          border-left: 3px solid #22c55e !important;
        }

        /* CENTER: GAME AREA (Compactado) */

        /* WHEEL - Modern Arc Style */
        .wheel-stage {
          flex: 0 0 auto;
          background: radial-gradient(ellipse at center top, rgba(255,255,255,0.02), transparent 70%);
          border: none;
          position: relative; 
          display: flex; justify-content: center; align-items: center;
          padding: 40px 20px 30px 20px;
          z-index: 1;
          margin-top: -380px;
          overflow: visible;
        }
        /* Bolinha dourada inferior removida */
        .wheel-mask { 
          width: 700px; 
          height: 700px; 
          position: relative; 
          display: flex;
          justify-content: center;
          align-items: center;
        }
        .wheel {
          width: 100%;
          height: 100%;
          position: relative;
          display: flex;
          justify-content: center;
          align-items: center;
          transition: transform 0.05s linear;
        }
        /* Outer rim */
        .wheel::before {
          content: '';
          position: absolute;
          width: 100%;
          height: 100%;
          border-radius: 50%;
          background: 
            radial-gradient(circle at 35% 35%, #1a1206, #0f0a04 60%, #000000);
          box-shadow: 
            inset 0 0 50px rgba(0,0,0,0.95),
            0 15px 50px rgba(0,0,0,0.8);
          z-index: 0;
        }
        /* Center hub - removed */
        .pointer {
          display: none;
        }
        /* Bolinha dourada acima da seta removida */
        .numbers { 
          position: absolute;
          width: 100%;
          height: 100%;
          border-radius: 50%;
          transform-style: preserve-3d;
        }
        .num { 
          width: 48px;
          height: 95px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 22px;
          font-weight: 900;
          color: #fff;
          position: absolute;
          left: 50%;
          top: 50%;
          clip-path: polygon(0% 0%, 100% 0%, 75% 100%, 25% 100%);
          border: 2px solid rgba(0,0,0,0.9);
          box-shadow: 
            0 5px 15px rgba(0,0,0,0.9), 
            inset 0 3px 6px rgba(255,255,255,0.2),
            inset 0 -3px 6px rgba(0,0,0,0.5);
          text-shadow: 0 3px 8px rgba(0,0,0,1);
          letter-spacing: 0.5px;
          transform-origin: 50% 50%;
          z-index: 10;
        }
        .num.red {
          background: linear-gradient(160deg, #e63946 0%, #d62828 50%, #9d0208 100%);
          border-color: rgba(100,0,0,0.9);
        }
        .num.black {
          background: linear-gradient(160deg, #2b2b2b 0%, #1a1a1a 50%, #000000 100%);
          border-color: rgba(0,0,0,1);
        }
        .num.green {
          background: linear-gradient(160deg, #2d6a4f 0%, #1b4332 50%, #0a1f15 100%);
          border-color: rgba(0,40,0,0.9);
        }
        .num.active {
          box-shadow: 
            0 0 30px rgba(255,215,0,1),
            0 0 60px rgba(255,215,0,0.6),
            inset 0 3px 6px rgba(255,255,255,0.5);
          z-index: 20;
          border-color: var(--gold-1);
          filter: brightness(1.7);
        }
        .pockets { 
          position: absolute;
          width: 100%;
          height: 100%;
          border-radius: 50%;
          pointer-events: none;
        }
        .pocket { 
          display: none;
        }
        .ball { 
          position: absolute;
          width: 30px;
          height: 30px;
          border-radius: 50%;
          background: radial-gradient(circle at 35% 35%, #fff, #f0f0f0 50%, #bbb 70%, #888);
          box-shadow: 
            0 0 22px rgba(255,255,255,1),
            0 6px 14px rgba(0,0,0,0.9),
            inset 0 -5px 7px rgba(0,0,0,0.5),
            inset 0 5px 7px rgba(255,255,255,0.7);
          z-index: 50;
          left: 50%;
          top: 50%;
          border: 1px solid rgba(255,255,255,0.4);
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.5s ease;
        }
        
        /* WIN/LOSE Indicator in center of wheel */
        .result-overlay {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%) scale(0);
          z-index: 600;
          pointer-events: none;
          opacity: 0;
          transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        .result-overlay.show {
          transform: translate(-50%, -50%) scale(1);
          opacity: 1;
        }
        .result-text {
          font-family: 'Cinzel', serif;
          font-size: 48px;
          font-weight: 700;
          text-transform: uppercase;
          letter-spacing: 4px;
          text-shadow: 
            0 0 20px currentColor,
            0 0 40px currentColor,
            0 4px 8px rgba(0,0,0,0.8);
          padding: 20px 40px;
          border-radius: 20px;
          border: 4px solid currentColor;
          background: rgba(0,0,0,0.8);
          backdrop-filter: blur(10px);
          animation: resultPulse 1s ease-in-out infinite;
        }
        .result-text.win {
          color: #22c55e;
          box-shadow: 
            0 0 40px rgba(34,197,94,0.6),
            0 0 80px rgba(34,197,94,0.3),
            inset 0 0 40px rgba(34,197,94,0.1);
        }
        .result-text.lose {
          color: #ef4444;
          box-shadow: 
            0 0 40px rgba(239,68,68,0.6),
            0 0 80px rgba(239,68,68,0.3),
            inset 0 0 40px rgba(239,68,68,0.1);
        }
        @keyframes resultPulse {
          0%, 100% { transform: scale(1); }
          50% { transform: scale(1.05); }
        }

        /* TABLE - Sobre o fundo */
        .table-container {
          flex: 1;
          background: transparent; 
          border: none;
          padding: 10px 20px 20px 20px;
          display: flex; flex-direction: column; align-items: center; 
          overflow-x: auto;
        }

        .table-layout {
          display: grid;
          grid-template-columns: 50px repeat(12, 42px) 50px; 
          gap: var(--gap);
        }

        .cell {
          height: 42px;
          background: var(--bg-element);
          border-radius: var(--radius);
          display: grid; place-items: center;
          font-weight: 700; font-size: 14px;
          color: #e5e7eb; cursor: pointer;
          position: relative; transition: all 0.1s; user-select: none;
        }
        .cell:hover { filter: brightness(1.2); transform: translateY(-1px); }
        .cell:active { transform: translateY(1px); }

        /* CORES ESCURAS */
        .c-red { background: linear-gradient(145deg, #b91c1c, #7f1d1d); box-shadow: inset 0 1px 0 rgba(255,255,255,0.05); border: 1px solid rgba(0,0,0,0.2); }
        .c-black { background: linear-gradient(145deg, #27272a, #09090b); box-shadow: inset 0 1px 0 rgba(255,255,255,0.05); border: 1px solid rgba(0,0,0,0.3); }
        .c-green { background: linear-gradient(145deg, #15803d, #14532d); box-shadow: inset 0 1px 0 rgba(255,255,255,0.05); border: 1px solid rgba(0,0,0,0.2); }
        
        .c-zero { grid-row: 1 / span 3; height: 100%; font-size: 16px; } 
        .c-2to1 { background: transparent; border: 1px solid rgba(255,255,255,0.1); color: var(--text-muted); font-size: 11px; }

        .cell.c-dozen {
          background: var(--bg-element); border: 1px solid rgba(255,255,255,0.05);
          font-size: 11px; text-transform: uppercase; color: #fff; grid-column: span 4;
        }

        .cell.c-simple {
          background: var(--bg-element); border: 1px solid rgba(255,255,255,0.05);
          font-size: 11px; text-transform: uppercase; color: #fff; grid-column: span 2;
        }
        
        .c-simple.red-btn { background: linear-gradient(145deg, #b91c1c, #7f1d1d); border-color: #7f1d1d; }
        .c-simple.black-btn { background: linear-gradient(145deg, #27272a, #09090b); border-color: #000; }

        .spacer-zero { grid-column: 1; visibility: hidden; }

        .chip-render {
          position: absolute; width: 20px; height: 20px;
          border: 1px solid #fff; border-radius: 50%;
          box-shadow: 0 3px 6px rgba(0,0,0,0.6);
          font-size: 8px; color: #fff; font-weight: 900;
          display: grid; place-items: center; pointer-events: none; z-index: 5;
        }
        
        /* Chip render colors - match the chip selector colors */
        .chip-render-purple { background: radial-gradient(circle at 30% 30%, #c084fc, #7c3aed); }
        .chip-render-blue { background: radial-gradient(circle at 30% 30%, #60a5fa, #2563eb); }
        .chip-render-green { background: radial-gradient(circle at 30% 30%, #4ade80, #16a34a); }
        .chip-render-red { background: radial-gradient(circle at 30% 30%, #f87171, #dc2626); }
        .chip-render-gold { background: radial-gradient(circle at 30% 30%, #fbbf24, #d97706); }
        .chip-render-default { background: radial-gradient(circle at 30% 30%, var(--accent), #b45309); }
        .cell.win-anim { 
          box-shadow: 
            0 0 0 3px var(--gold-1), 
            0 0 20px var(--gold-2), 
            0 0 40px var(--accent),
            inset 0 0 20px rgba(255,215,0,0.3); 
          z-index: 10; 
          border-color: var(--gold-1);
          animation: winPulse 1.5s ease-in-out infinite;
          transform: scale(1.1);
        }
        
        @keyframes winPulse {
          0%, 100% { 
            box-shadow: 
              0 0 0 3px var(--gold-1), 
              0 0 20px var(--gold-2), 
              0 0 40px var(--accent),
              inset 0 0 20px rgba(255,215,0,0.3);
          }
          50% { 
            box-shadow: 
              0 0 0 4px var(--gold-2), 
              0 0 30px var(--gold-1), 
              0 0 60px var(--accent),
              inset 0 0 30px rgba(255,215,0,0.5);
          }
        }

        /* RIGHT CONTROLS */
        .controls-body { padding: 12px; display: flex; flex-direction: column; gap: 12px; overflow-y: auto; }
        .label { font-size: 10px; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; display:block;}
        
        /* Toggle Manual/Auto */
        .mode-toggle { display: flex; background: var(--bg-element); border-radius: 10px; padding: 3px; margin-bottom: 8px; }
        .mode-btn { flex: 1; padding: 6px; text-align: center; font-size: 10px; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 8px; transition: all 0.2s; color: var(--text-muted); }
        .mode-btn.active { background: var(--accent); color: #fff; }
        
        .bet-input { background: #000; border: 1px solid #222; color: #fff; padding: 12px; border-radius: 10px; font-size: 16px; font-weight: bold; width: 100%; outline:none; }
        .bet-input:focus { border-color: var(--accent); }
        .bet-limits { font-size: 9px; color: #555; margin-top: 4px; margin-bottom: 8px; display: flex; justify-content: space-between; }
        
        .chips-area { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px 10px; row-gap: 14px; margin-top: 10px; margin-bottom: 10px; }
        .chip-select {
          aspect-ratio: 1; border-radius: 50%; border: 3px solid transparent;
          display: grid; place-items: center; font-size: 11px; font-weight: 900; cursor: pointer;
          box-shadow: 0 4px 8px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255,255,255,0.1); position: relative;
          transition: all 0.15s;
        }
        .chip-select::before { 
          content:''; position: absolute; inset: 6px; 
          border: 2px dashed rgba(255,255,255,0.3); border-radius: 50%; 
        }
        .chip-select:hover { transform: translateY(-2px); }
        .chip-select.active { border-color: #fff; transform: scale(1.15); box-shadow: 0 6px 16px rgba(255,255,255,0.3); }
        
        /* Chip Colors */
        .chip-purple { background: radial-gradient(circle at 30% 30%, #c084fc, #7c3aed); color: #fff; }
        .chip-blue { background: radial-gradient(circle at 30% 30%, #60a5fa, #2563eb); color: #fff; }
        .chip-green { background: radial-gradient(circle at 30% 30%, #4ade80, #16a34a); color: #fff; }
        .chip-red { background: radial-gradient(circle at 30% 30%, #f87171, #dc2626); color: #fff; }
        .chip-gold { background: radial-gradient(circle at 30% 30%, #fbbf24, #d97706); color: #fff; }
        .chip-clear { background: #1c1f24; border: 2px dashed #444; color: #888; font-size: 18px; }
        .chip-clear::before { display: none; }
        
        /* Total Bet Display */
        .total-bet-display {
          background: linear-gradient(145deg, rgba(234, 88, 12, 0.08), rgba(249, 115, 22, 0.05));
          border: 1px solid rgba(234, 88, 12, 0.2);
          border-radius: 10px;
          padding: 10px 14px;
          text-align: center;
          margin: 8px 0;
        }
        .total-bet-label {
          font-size: 9px;
          color: var(--text-muted);
          font-weight: 700;
          text-transform: uppercase;
          letter-spacing: 1px;
          margin-bottom: 4px;
        }
        .total-bet-value {
          font-size: 18px;
          font-weight: 800;
          color: var(--accent);
          text-shadow: 0 0 10px rgba(234, 88, 12, 0.4);
        }
        .total-bet-display.has-bets {
          background: linear-gradient(145deg, rgba(234, 88, 12, 0.15), rgba(249, 115, 22, 0.08));
          border-color: rgba(234, 88, 12, 0.4);
          box-shadow: 0 0 15px rgba(234, 88, 12, 0.2);
        }
        
        .btn-big {
          width: 100%; padding: 12px; background: linear-gradient(to bottom, var(--accent), #ea580c);
          color: #fff; border: none; border-radius: 12px; font-weight: 800; font-size: 13px; text-transform: uppercase;
          cursor: pointer; box-shadow: 0 4px 12px rgba(234, 88, 12, 0.4); transition: 0.1s; letter-spacing: 0.5px;
        }
        .btn-big:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn-big:disabled { background: #333; color: #555; box-shadow: none; cursor: not-allowed; }
        
        /* History Numbers - Square format like table cells */
        .history-coins { 
          display: grid; 
          grid-template-columns: repeat(5, 1fr); 
          gap: 8px; 
        }
        .coin-slot {
          aspect-ratio: 1;
          border-radius: var(--radius);
          border: 1px dashed rgba(255,255,255,0.15);
          background: rgba(255,255,255,0.02);
          display: grid; place-items: center;
          font-weight: 700; font-size: 10px;
          color: transparent;
          transition: all 0.3s ease;
          position: relative;
        }
        .coin-slot.filled {
          border-style: solid;
          box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
          color: #e5e7eb;
          animation: numberFill 0.4s ease-out;
        }
        @keyframes numberFill {
          0% { transform: scale(0.7); opacity: 0; }
          50% { transform: scale(1.1); }
          100% { transform: scale(1); opacity: 1; }
        }
        .coin-red { 
          background: linear-gradient(145deg, #b91c1c, #7f1d1d); 
          border-color: rgba(0,0,0,0.2);
        }
        .coin-black { 
          background: linear-gradient(145deg, #27272a, #09090b); 
          border-color: rgba(0,0,0,0.3);
        }
        .coin-green { 
          background: linear-gradient(145deg, #15803d, #14532d); 
          border-color: rgba(0,0,0,0.2);
        }
        .chat-msgs { flex: 1; overflow-y: auto; padding: 15px; font-size: 11px; color: #9ca3af; min-height: 0; }
        .chat-row { 
          margin-bottom: 12px; line-height: 1.5; 
          padding: 8px; border-radius: 10px;
          background: rgba(255,255,255,0.02);
        }
        .chat-row:hover { background: rgba(255,255,255,0.04); }
        .chat-input { 
          padding: 12px; background: #0b0d10; border: none; 
          border-top: 1px solid #222; color: #fff; width: 100%; 
          outline: none; font-size: 11px; 
        }
        .chat-input:focus { background: #131519; }

        @media (max-width: 1100px) {
          .dashboard { grid-template-columns: 1fr; overflow-y: auto; }
          .wheel-mask { width: 100%; max-width: 320px; margin: 0 auto; }
          .wheel { width: 320px; height: 320px; top: -160px; }
          .table-container { align-items: flex-start; } 
        }
        
        /* MODAL STYLES */
        .modal-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.8);
          backdrop-filter: blur(5px);
          display: none;
          align-items: center;
          justify-content: center;
          z-index: 9999;
          animation: fadeIn 0.2s ease;
        }
        .modal-overlay.show {
          display: flex;
        }
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        .modal-content {
          background: var(--bg-panel);
          border-radius: 16px;
          border: 1px solid rgba(255,255,255,0.1);
          box-shadow: 0 20px 60px rgba(0,0,0,0.5);
          max-width: 600px;
          width: 90%;
          max-height: 80vh;
          overflow-y: auto;
          animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
          from { transform: translateY(30px); opacity: 0; }
          to { transform: translateY(0); opacity: 1; }
        }
        .modal-header {
          padding: 20px 24px;
          border-bottom: 1px solid rgba(255,255,255,0.05);
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        .modal-title {
          font-size: 18px;
          font-weight: 700;
          color: var(--text-main);
        }
        .modal-close {
          width: 32px;
          height: 32px;
          border-radius: 8px;
          background: rgba(255,255,255,0.05);
          border: none;
          color: #999;
          font-size: 20px;
          cursor: pointer;
          transition: all 0.2s;
        }
        .modal-close:hover {
          background: rgba(255,255,255,0.1);
          color: #fff;
        }
        .modal-body {
          padding: 24px;
        }
        
        /* Avatar Selection */
        .avatar-grid {
          display: grid;
          grid-template-columns: repeat(7, 1fr);
          gap: 20px;
          max-height: 65vh;
          overflow-y: auto;
          padding: 12px;
        }
        .avatar-option {
          position: relative;
          width: 100%;
          padding-bottom: 100%; /* Cria aspect ratio 1:1 */
          border-radius: 16px;
          background: var(--bg-element);
          border: 3px solid transparent;
          cursor: pointer;
          transition: all 0.2s;
          overflow: hidden;
        }
        .avatar-option img {
          position: absolute;
          top: 12px;
          left: 12px;
          right: 12px;
          bottom: 12px;
          width: calc(100% - 24px);
          height: calc(100% - 24px);
          object-fit: cover;
          border-radius: 8px;
        }
        .avatar-option:hover {
          background: rgba(255,255,255,0.1);
          transform: scale(1.05);
          border-color: rgba(249, 115, 22, 0.3);
        }
        .avatar-option.selected {
          border-color: var(--accent);
          background: rgba(249, 115, 22, 0.1);
          box-shadow: 0 0 15px rgba(249, 115, 22, 0.3);
        }
        
        /* Settings Form */
        .settings-group {
          margin-bottom: 24px;
        }
        .settings-label {
          display: block;
          font-size: 11px;
          font-weight: 700;
          text-transform: uppercase;
          color: var(--text-muted);
          margin-bottom: 8px;
          letter-spacing: 1px;
        }
        .settings-input {
          width: 100%;
          padding: 12px 14px;
          background: var(--bg-element);
          border: 1px solid rgba(255,255,255,0.05);
          border-radius: 10px;
          color: var(--text-main);
          font-size: 13px;
          font-family: monospace;
          transition: all 0.2s;
        }
        .settings-input:focus {
          outline: none;
          border-color: var(--accent);
          box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }
        .settings-hint {
          font-size: 10px;
          color: #666;
          margin-top: 6px;
        }
        .settings-buttons {
          display: flex;
          gap: 12px;
          margin-top: 24px;
        }
        .modal-btn {
          flex: 1;
          padding: 12px;
          border-radius: 10px;
          border: none;
          font-weight: 700;
          font-size: 12px;
          text-transform: uppercase;
          cursor: pointer;
          transition: all 0.2s;
        }
        .modal-btn-primary {
          background: linear-gradient(to bottom, var(--accent), #ea580c);
          color: #fff;
          box-shadow: 0 4px 12px rgba(234, 88, 12, 0.4);
        }
        .modal-btn-primary:hover {
          filter: brightness(1.1);
          transform: translateY(-1px);
        }
        .modal-btn-secondary {
          background: var(--bg-element);
          color: var(--text-muted);
        }
        .modal-btn-secondary:hover {
          background: rgba(255,255,255,0.1);
          color: var(--text-main);
        }
      </style>
    </head>
    <body>

      <header>
        <div class="brand">
          <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#bf953f"/><stop offset="0.5" stop-color="#fcf6ba"/><stop offset="1" stop-color="#b38728"/></linearGradient>
            </defs>
            <path d="M28 4A24 24 0 0 0 28 60" stroke="url(#g1)" stroke-width="2" stroke-dasharray="4 2"/>
            <path d="M42 16C30 16 30 26 42 26 54 26 54 44 36 44L32 44" stroke="url(#g1)" stroke-width="5" stroke-linecap="round"/>
            <path d="M32 24C44 24 44 6 26 6L22 6" stroke="url(#g1)" stroke-width="5" stroke-linecap="round"/>
            <path d="M24 44L24 54M24 44C24 44 18 50 18 40 18 36 24 32 24 32 24 32 30 36 30 40 30 50 24 44 24 44Z" fill="url(#g1)"/>
          </svg>
          <div class="brand-text">
            <span class="brand-title">Strenger</span>
            <span class="brand-subtitle">Roulette</span>
          </div>
        </div>
          <div class="balance-main">
            <div class="balance-icon">üí∞</div>
            <span class="balance-amount" id="balance">R$ 1.000,00</span>
            <span id="btnReset" style="cursor:pointer;opacity:0.5;font-size:16px" title="Reset Balance">‚Ü∫</span>
          </div>
        <div class="user-stats">
          <div class="stat-box" id="btnConnect" style="padding:8px 12px;gap:10px;cursor:pointer;height:54px;">
            <div id="dot" style="width:8px;height:8px;border-radius:50%;background:#ef4444;"></div>
            <span id="connText">Offline</span>
          </div>
          <div class="stat-box" id="settingsBtn" style="padding:8px 12px;justify-content:center;cursor:pointer;font-size:20px;height:54px;aspect-ratio:1;" title="Settings">‚öôÔ∏è</div>
          <div class="stat-box" style="padding:8px 12px;gap:10px;cursor:pointer;transition:all 0.2s;height:54px;" onclick="openModal('avatarModal')" title="Click to change profile">
            <div id="userAvatar" style="width:38px;height:38px;border-radius:50%;padding:2px;justify-content:center;font-weight:700;font-size:18px;overflow:hidden;flex-shrink:0;display:flex;align-items:center;">
              <span id="userId">U</span>
            </div>
            <div style="display:flex;flex-direction:column;line-height:1.2;">
              <span id="displayUsername" style="font-size:13px;font-weight:600;color:#e5e7eb;">User</span>
              <span style="font-size:9px;color:#666;text-transform:uppercase;letter-spacing:0.5px;">Player</span>
            </div>
          </div>
        </div>
      </header>

      <div class="dashboard">
        <div class="left-column">
        <aside class="panel">
          <div class="panel-head"><span>Active Players</span><span style="color:var(--accent)" id="playerCount">21</span></div>
          <div class="panel-body" id="playerList"></div>
        </aside>
        </div>

        <section class="game-area">
          <div class="wheel-stage">
            <div class="wheel-mask">
              <div class="pointer"></div>
              <div class="wheel" id="wheel">
                <div class="numbers" id="numbers"></div>
                <div class="pockets" id="pockets"></div>
                <div class="ball" id="ball"></div>
              </div>
              <div class="result-overlay" id="resultOverlay">
                <div class="result-text" id="resultText">WIN</div>
              </div>
            </div>
          </div>

          <div class="table-container">
            <div class="table-layout" id="tableGrid"></div>
          </div>
        </section>

        <div class="right-column">
        <aside class="panel">
          <div class="panel-head">Betting Controls</div>
          <div class="panel-body controls-body">
            <div class="mode-toggle">
              <div class="mode-btn active" id="btnManual">Manual</div>
              <div class="mode-btn" id="btnAuto">Auto</div>
            </div>
            
            <div>
              <span class="label">Bet Amount</span>
              <input type="number" class="bet-input" id="betInput" value="10" step="5" min="5" max="10000">
              <div class="bet-limits">
                <span>Min bet: $5</span>
                <span>Max bet: $10K</span>
              </div>
            </div>
            
            <div>
              <span class="label">Chip Value</span>
              <div class="chips-area">
                <div class="chip-select chip-purple active" data-val="10">10</div>
                <div class="chip-select chip-blue" data-val="25">25</div>
                <div class="chip-select chip-green" data-val="50">50</div>
                <div class="chip-select chip-red" data-val="100">100</div>
                <div class="chip-select chip-gold" data-val="250">250</div>
                <div class="chip-select chip-blue" data-val="500">500</div>
                <div class="chip-select chip-green" data-val="1000">1K</div>
                <div class="chip-select chip-red" data-val="5000">5K</div>
                <div class="chip-select chip-purple" data-val="10000">10K</div>
                <div class="chip-select chip-clear" id="btnClear">‚úï</div>
              </div>
            </div>
            
            <!-- Total Bet Display -->
            <div class="total-bet-display" id="totalBetDisplay">
              <div class="total-bet-label">Total Bet on Table</div>
              <div class="total-bet-value">R$ 0,00</div>
            </div>
            
            <button class="btn-big" id="btnAction">Place Bet</button>
            </div>
          </aside>
          
          <aside class="panel">
            <div class="panel-head">Recent Numbers</div>
            <div class="panel-body" style="padding: 8px; overflow: hidden;">
              <div class="history-coins" id="historyCoins"></div>
              </div>
          </aside>
            </div>
            
        <aside class="panel top-players-full">
          <div class="panel-head">
            <span>Recent Bets & Results <span id="liveDot" style="display:none;color:#22c55e;font-size:8px;vertical-align:middle;">‚óè LIVE</span></span>
            <span style="color:var(--accent)" id="totalBets">0 bets</span>
          </div>
          <div class="tabs">
            <div class="tab active">All Bets</div>
            <div class="tab">Wins Only</div>
            <div class="tab">My Bets</div>
            </div>
          <div class="panel-body" style="padding: 0;">
            <div class="leaderboard">
              <div class="leaderboard-header">
                <div>User</div>
                <div>Time</div>
                <div>Number</div>
                <div>Bet Amount</div>
                <div>Result</div>
                <div>Profit/Loss</div>
          </div>
              <div id="betsLog">
                <!-- Bets will be added here dynamically -->
              </div>
            </div>
          </div>
        </aside>
        
        <aside class="panel chat-extended">
            <div class="panel-head">
              <span>Live Chat <span class="live-indicator" id="chatLiveDot" style="display:none;">‚óè LIVE</span></span>
              <span style="color:var(--accent)" id="chatViewers">0 üëÅ</span>
            </div>
          <div class="panel-body" style="padding: 0; display: flex; flex-direction: column;">
            <div class="chat-msgs" id="chatBox">
              <div class="chat-row">
                <div style="margin-bottom:4px"><span style="color:#60a5fa;font-weight:600">Daniel Allison</span> <span style="color:#555;font-size:9px;margin-left:6px">3:27 pm</span></div>
                <span style="color:#d1d5db">Why does it seem like everyone's betting on black lol! My big chips are on reds, and it feels like my lucky day today üé∞üí∞</span>
              </div>
              <div class="chat-row">
                <div style="margin-bottom:4px"><span style="color:#a78bfa;font-weight:600">Nwamaka Diana</span> <span style="color:#555;font-size:9px;margin-left:6px">3:28 pm</span></div>
                <span style="color:#d1d5db">Lmao! You can't be so sureüòÇüòÇ It'd have been nicer if we could bet in stable coins üí∞üî•</span>
              </div>
              <div class="chat-row">
                <div style="margin-bottom:4px"><span style="color:#34d399;font-weight:600">Mario Francis</span> <span style="color:#555;font-size:9px;margin-left:6px">3:30 pm</span></div>
                <span style="color:#d1d5db">defs loving the commVQUnity experience on this product!üî•</span>
              </div>
            </div>
            <div style="display:flex;align-items:center;background:#0b0d10;border-top:1px solid #222;padding:8px 12px">
              <input class="chat-input" placeholder="Say something..." style="border:none;padding:0;border-top:none;background:transparent">
              <button style="background:var(--accent);border:none;color:#fff;width:32px;height:32px;border-radius:10px;cursor:pointer;font-size:16px;display:grid;place-items:center">‚û§</button>
            </div>
          </div>
        </aside>
      </div>

    <script>
    (() => {
      /* ====================================================
      * STRENGER CASINO - ROULETTE FRONTEND
      * 
      * WebSocket Integration with MuleSoft Backend
      * 
      * MESSAGE FORMATS:
      * 
      * 1. CLIENT -> SERVER (Bet):
      *    {
      *      eventType: "BET",
      *      userId: "user1234",
      *      gameId: "roulette-v1",
      *      amount: 100,
      *      bets: { "number:5": 50, "simple:RED": 50 },
      *      timestamp: "2025-01-01T12:00:00.000Z"
      *    }
      * 
      * 2. SERVER -> CLIENT (ACK):
      *    { status: "RECEIVED" }
      * 
      * 3. SERVER -> CLIENT (Result) - RECOMENDADO:
      *    {
      *      eventType: "ROUND_RESULT",
      *      userId: "user1234",
      *      gameId: "roulette-v1",
      *      roundId: "r-2025-12-19T21:57:50.187790965Z",
      *      number: 17,              // ‚ö†Ô∏è IMPORTANTE: n√∫mero espec√≠fico (0-36)
      *      result: "RED",           // cor do n√∫mero (opcional)
      *      win: true,
      *      winAmount: 250.50,       // quanto ganhou (opcional)
      *      newBalance: 1250.50,
      *      timestamp: "2025-01-01T12:00:00.000Z"
      *    }
      * 
      * 4. CLIENT -> SERVER (Chat):
      *    {
      *      eventType: "CHAT_MESSAGE",
      *      userId: "user1234",
      *      message: "Hello everyone!",
      *      timestamp: "2025-01-01T12:00:00.000Z"
      *    }
      * 
      * 5. SERVER -> ALL CLIENTS (Chat Broadcast):
      *    {
      *      eventType: "CHAT_MESSAGE",
      *      userId: "user1234",
      *      message: "Hello everyone!",
      *      timestamp: "2025-01-01T12:00:00.000Z"
      *    }
      * 
      * 6. CLIENT -> ALL CLIENTS (Bet Result Broadcast):
      *    {
      *      eventType: "BET_RESULT",
      *      userId: "user1234",
      *      number: 17,
      *      betAmount: 100,
      *      win: true,
      *      winAmount: 250,
      *      timestamp: "2025-01-01T12:00:00.000Z"
      *    }
      * 
      * NOTA: Se o backend enviar apenas "result": "RED/BLACK/GREEN"
      * sem o campo "number", o frontend vai gerar um n√∫mero aleat√≥rio
      * compat√≠vel com a cor. Isso funciona mas n√£o √© ideal para auditoria.
      * 
      * ==================================================== */
      
      /* CONFIG */
      const $ = id => document.getElementById(id);
      const WHEEL = [0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,30,8,23,10,5,24,16,33,1,20,14,31,9,22,18,29,7,28,12,35,3,26];
      const REDS = new Set([1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36]);
      const SEG = 360 / 37;
      
      // Carrega configura√ß√µes salvas do localStorage
      let WS_URL = localStorage.getItem('wsUrl') || "ws://ws-gw-qxtrdq.ekvjny.bra-s1.cloudhub.io/ws";
      let API_URL = localStorage.getItem('apiUrl') || "http://ws-gw-qxtrdq.ekvjny.bra-s1.cloudhub.io/api";
      
      // Lista de avatares dispon√≠veis (imagens)
      const AVATARS = [
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_1.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_2.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_3.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_4.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_5.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_6.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_7.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_8.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_9.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_10.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_11.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_12.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_13.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_14.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_15.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_16.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_17.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_18.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_19.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_20.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_21.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_22.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_23.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_24.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_25.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_26.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_27.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_28.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_29.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_30.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_31.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_32.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_33.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_34.png',
        'https://cdn.jsdelivr.net/gh/alohe/avatars/png/memo_35.png'
      ];
      
      // N√£o carrega avatar do localStorage - cada aba come√ßa sem avatar (apenas inicial)
      let selectedAvatar = null; 
      
      // SEMPRE gera username aleat√≥rio para cada aba/sess√£o (entre 100-9999)
      let username = 'user' + Math.floor(Math.random() * (9999 - 100 + 1) + 100);
      
      // Gera sessionId √∫nico para esta aba (n√£o persiste no localStorage)
      let sessionId = 'tab_' + Date.now() + '_' + Math.floor(Math.random()*999999);
      let pid = username + '_' + sessionId; // userId √∫nico para backend
      
      console.log('üÜî Session initialized:');
      console.log('   Username:', username);
      console.log('   SessionId:', sessionId);
      console.log('   Full userId (backend):', pid);

      let ws=null, spinning=false, bal=0, chip=10, bets=new Map();
      let audioCtx=null, autoMode=false, spinTimeout=null, autoSpinTimeout=null;
      let betsLog = []; // Armazena hist√≥rico de apostas
      
      // Mapeamento de valor do chip para cor
      const chipColors = {
        10: 'purple',
        25: 'blue',
        50: 'green',
        100: 'red',
        250: 'gold',
        500: 'blue',
        1000: 'green',
        5000: 'red',
        10000: 'purple'
      };
      let currentBetAmount = 0; // Armazena valor da aposta atual
      let autoSpinDelay = 2000; // Delay entre spins autom√°ticos (2 segundos)
      let soundEnabled = localStorage.getItem('soundEnabled') !== 'false'; // Som ativado por padr√£o
      console.log('üîä Sound initialized:', soundEnabled, '(localStorage value:', localStorage.getItem('soundEnabled') + ')');

      const playTick = () => {
        if(!soundEnabled) {
          console.log('üîá Sound disabled, skipping tick');
          return;
        }
        if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        if(audioCtx.state==='suspended') audioCtx.resume();
        const o=audioCtx.createOscillator(), g=audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.frequency.setValueAtTime(800, audioCtx.currentTime);
        o.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime+0.01);
        g.gain.setValueAtTime(0.05, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+0.03);
        o.start(); o.stop(audioCtx.currentTime+0.04);
      };

      const fmt = v => '$' + v.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
      
      // Extrai username do userId (remove sessionId)
      // Ex: "user123_tab_1234567_890" ‚Üí "user123"
      function extractUsername(userId) {
        if(!userId) return 'Unknown';
        const parts = userId.split('_tab_');
        return parts[0]; // Retorna apenas a parte antes de "_tab_"
      }
      
      function updateUI() {
        // Mostra avatar ou inicial no header
        const userIdElement = $('userId');
        if(userIdElement) {
          if(selectedAvatar && selectedAvatar.startsWith('http')) {
            // Avatar com imagem
            userIdElement.innerHTML = `<img src="${selectedAvatar}" alt="Avatar" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
          } else if(selectedAvatar) {
            // Fallback para emoji/texto
            userIdElement.textContent = selectedAvatar;
          } else {
            // Sem avatar - mostra apenas a inicial
            userIdElement.textContent = username[0].toUpperCase();
          }
        }
        
        // Atualiza cor de fundo do avatar com a cor do chat
        const userColor = getUserColor(pid);
        const avatarElement = $('userAvatar');
        if(avatarElement) {
          avatarElement.style.background = userColor;
        }
        
        // Atualiza nome do usu√°rio no header
        const displayUsernameElement = $('displayUsername');
        if(displayUsernameElement) {
          displayUsernameElement.textContent = username;
        }
        
        $('balance').textContent = fmt(bal);
        $('btnAction').textContent = spinning ? "SPINNING..." : "PLACE BET"; $('btnAction').disabled = spinning;
        
        // Calcula total de apostas
        let totalBet = 0;
        bets.forEach(v => totalBet += v);
        
        // Atualiza display de Total Bet
        const totalBetDisplay = $('totalBetDisplay');
        const totalBetValue = totalBetDisplay.querySelector('.total-bet-value');
        if(totalBetValue) {
          totalBetValue.textContent = fmt(totalBet);
          
          // Adiciona destaque se tem apostas
          if(totalBet > 0) {
            totalBetDisplay.classList.add('has-bets');
          } else {
            totalBetDisplay.classList.remove('has-bets');
          }
        }
        
        document.querySelectorAll('.chip-render').forEach(e=>e.remove());
        document.querySelectorAll('.cell.win-anim').forEach(e=>e.classList.remove('win-anim'));
        bets.forEach((amt, k) => {
          const [t, v] = k.split(':');
          const el = document.querySelector(`.cell[data-k="${t}"][data-v="${v}"]`);
          if(el) {
            const c = document.createElement('div');
            
            // Determina a cor baseada no chip selecionado
            const chipColor = chipColors[chip] || 'default';
            c.className = `chip-render chip-render-${chipColor}`;
            
            // Formata o valor
            c.textContent = amt >= 1000 ? (amt/1000).toFixed(1)+'k' : amt;
            
            el.appendChild(c);
          }
        });
      }

      function addBet(k, v, m=1) {
        if(spinning) return;
        const key = `${k}:${v}`;
        const next = (bets.get(key)||0) + (chip * m);
        if(next<=0) bets.delete(key); else bets.set(key, next);
        updateUI();
      }

      /* --- TABLE BUILDER --- */
      function buildTable() {
        const grid = $('tableGrid');
        
        // 1. ZERO
        grid.appendChild(mkCell('0', 'c-zero c-green', 'number', '0'));

        // 2. NUMBERS
        const rows = [3,2,1];
        for(let r=0; r<3; r++) {
          for(let c=0; c<12; c++) {
            const n = rows[r] + (c*3);
            grid.appendChild(mkCell(n, REDS.has(n)?'c-red':'c-black', 'number', n));
          }
          grid.appendChild(mkCell('2:1', 'c-2to1', 'col', 3-r));
        }

        // 3. DOZENS
        grid.appendChild(mkSpacer()); 
        grid.appendChild(mkCell('1st 12', 'c-dozen', 'dozen', '1-12'));
        grid.appendChild(mkCell('2nd 12', 'c-dozen', 'dozen', '13-24'));
        grid.appendChild(mkCell('3rd 12', 'c-dozen', 'dozen', '25-36'));
        grid.appendChild(mkSpacer()); 

        // 4. SIMPLE
        grid.appendChild(mkSpacer());
        grid.appendChild(mkCell('1-18', 'c-simple', 'simple', '1-18'));
        grid.appendChild(mkCell('EVEN', 'c-simple', 'simple', 'EVEN'));
        grid.appendChild(mkCell('RED', 'c-simple red-btn', 'simple', 'RED'));
        grid.appendChild(mkCell('BLACK', 'c-simple black-btn', 'simple', 'BLACK'));
        grid.appendChild(mkCell('ODD', 'c-simple', 'simple', 'ODD'));
        grid.appendChild(mkCell('19-36', 'c-simple', 'simple', '19-36'));
        grid.appendChild(mkSpacer());
      }

      function mkCell(lbl, cls, k, v) {
        const d = document.createElement('div');
        d.className = `cell ${cls}`; d.textContent = lbl;
        d.dataset.k = k; d.dataset.v = v;
        d.onclick = e => addBet(k, v, e.altKey?-1:1);
        return d;
      }
      function mkSpacer() { const d=document.createElement('div'); d.className='spacer-zero'; return d; }

      /* --- WHEEL --- */
      const wheel=$('wheel'), ball=$('ball');

      function initWheel() {
        const container = $('numbers');
        const pocketsContainer = $('pockets');
        
        // Create all 37 numbers in full circular layout
        const anglePerPocket = 360 / 37;
        const radius = 300; // Distance from center to number
        
        for(let i = 0; i < WHEEL.length; i++) {
          const n = WHEEL[i];
          const angle = i * anglePerPocket;
          
          // Create number cell
          const cell = document.createElement('div');
          cell.className = 'num';
          cell.textContent = n;
          cell.dataset.number = n;
          cell.dataset.angle = angle;
          
          // Add color class based on number type
          if(n === 0) {
            cell.classList.add('green');
          } else if(REDS.has(n)) {
            cell.classList.add('red');
          } else {
            cell.classList.add('black');
          }
          
          // Calculate position using trigonometry
          const radians = (angle - 90) * (Math.PI / 180); // -90 so 0¬∞ is at top
          const x = radius * Math.cos(radians);
          const y = radius * Math.sin(radians);
          
          // Position and rotate trapezoid
          cell.style.left = `calc(50% + ${x}px)`;
          cell.style.top = `calc(50% + ${y}px)`;
          cell.style.transform = `translate(-50%, -50%) rotate(${angle}deg)`;
          
          // Create inner span to rotate the number text only
          const numberSpan = document.createElement('span');
          numberSpan.textContent = cell.textContent;
          numberSpan.style.display = 'inline-block';
          numberSpan.style.transform = 'rotate(180deg)';
          cell.textContent = '';
          cell.appendChild(numberSpan);
          
          container.appendChild(cell);
          
          // Create divider line between pockets
          const line = document.createElement('div');
          line.className = 'pocket';
          line.style.transform = `rotate(${angle}deg)`;
          pocketsContainer.appendChild(line);
        }
      }

      let wheelRotation = 0;
      let wheelSpeed = 0; // Velocidade atual da wheel (graus/segundo)
      let wheelRAF = 0;
      let wheelLastTs = 0;
      let wheelTargetNumber = null; // N√∫mero que deve parar
      let wheelStopTime = 0; // Quando come√ßar a parar
      let wheelStartStopTime = 0; // Momento em que come√ßou a parar
      
      let ballAngle = -90; // Posi√ß√£o angular da bolinha (graus)
      let ballOmega = 0; // Velocidade angular da bolinha
      let ballRAF = 0;
      let ballLastTs = 0;
      let lastSector = -1;
      let isSpinning = false;

      // Easing customizado (igual ao index001.html)
      function easeOutCustom(t) { 
        return 1 - Math.pow(1 - t, 4); 
      }

      function setBallAngle(deg) {
        ballAngle = deg;
        // Posiciona bolinha em √≥rbita circular
        const rect = wheel.parentElement.getBoundingClientRect();
        const radius = Math.min(rect.width, rect.height) * 0.455;
        const rad = (deg * Math.PI) / 180;
        const x = Math.cos(rad) * radius;
        const y = Math.sin(rad) * radius;
        ball.style.left = '50%';
        ball.style.top = '50%';
        ball.style.transform = `translate(-50%, -50%) translate(${x}px, ${y}px)`;
      }

      function startBallOrbit() {
        ballLastTs = 0;
        ballOmega = 820 + Math.random() * 220; // 820-1040¬∞/s (MESMO sentido da wheel)
        lastSector = -1;
        cancelAnimationFrame(ballRAF);
        
        console.log('‚ö™ Ball orbit started - Speed:', ballOmega.toFixed(1), '¬∞/s');

        function tick(ts) {
          if(!isSpinning) return;
          
          if(!ballLastTs) ballLastTs = ts;
          const dt = (ts - ballLastTs) / 1000;
          ballLastTs = ts;

          // Desacelera gradualmente (mesma f√≠sica do index001.html)
          ballOmega = Math.max(260, ballOmega * Math.pow(0.996, dt * 60));
          ballAngle = (ballAngle + ballOmega * dt) % 360;
          setBallAngle(ballAngle);

          // Som ao passar setores
          const currentSector = Math.floor(((ballAngle % 360) + 360) / SEG);
          if(lastSector !== -1 && currentSector !== lastSector) {
            playTick();
          }
          lastSector = currentSector;

          ballRAF = requestAnimationFrame(tick);
        }

        ballRAF = requestAnimationFrame(tick);
      }
      
      // Sincroniza bolinha com a wheel (adaptado do index001.html)
      async function syncBallToWheel(wheelDelta, durationMs, targetNumber) {
        cancelAnimationFrame(ballRAF);
        ballRAF = 0;
        
        const startAngle = ballAngle;
        
        // Alvo √© 180¬∞ (bottom) ao inv√©s de -90¬∞ (top)
        let targetBottom = 180;
        while(targetBottom < startAngle) targetBottom += 360;
        
        const wheelRotations = Math.floor(wheelDelta / 360);
        const finalBallTarget = targetBottom + (wheelRotations * 360);
        
        const t0 = performance.now();
        
        console.log('‚ö™ Syncing ball to wheel:');
        console.log('   Start angle:', startAngle.toFixed(1), '¬∞');
        console.log('   Target angle:', finalBallTarget.toFixed(1), '¬∞');
        console.log('   Duration:', durationMs, 'ms');

        return new Promise((resolve) => {
          function step(t) {
            const elapsed = t - t0;
            const progress = Math.min(1, elapsed / durationMs);
            const eased = easeOutCustom(progress);
            const currentPos = startAngle + (finalBallTarget - startAngle) * eased;
            setBallAngle(currentPos);
            
            // Som ao passar setores
            const currentSector = Math.floor(((currentPos % 360) + 360) / SEG);
            if(lastSector !== -1 && currentSector !== lastSector) {
              playTick();
            }
            lastSector = currentSector;
            
            if(progress < 1) {
              requestAnimationFrame(step);
            } else {
              ballAngle = 180; // Garante posi√ß√£o final exata
              setBallAngle(180);
              console.log('‚ö™ Ball stopped at 180¬∞ ‚úì');
              
              // Esconde ap√≥s 2s
              setTimeout(() => {
                ball.style.opacity = '0';
              }, 2000);
              
              resolve();
            }
          }
          requestAnimationFrame(step);
        });
      }

      // Inicia rota√ß√£o cont√≠nua da wheel (sem saber o n√∫mero ainda)
      function startWheelSpin() {
        if(isSpinning) return;
        
        isSpinning = true;
        wheelTargetNumber = null;
        wheelSpeed = 720; // 720¬∞/s = 2 rota√ß√µes por segundo
        wheelLastTs = 0;
        wheelStopTime = 0;
        
        console.log('üé° Wheel spinning started - waiting for result...');
        
        // Mostra e inicia √≥rbita da bolinha
        ballAngle = -90 + Math.random() * 360;
        setBallAngle(ballAngle);
        ball.style.opacity = '1';
        startBallOrbit();
        
        cancelAnimationFrame(wheelRAF);
        
        let targetRotation = 0;
        let startRotation = 0;
        let stopStartTime = 0;
        
        function tick(ts) {
          if(!isSpinning) return;
          
          if(!wheelLastTs) wheelLastTs = ts;
          const dt = (ts - wheelLastTs) / 1000; // delta em segundos
          wheelLastTs = ts;
          
          // Se j√° recebeu o n√∫mero, come√ßa a desacelerar
          if(wheelTargetNumber !== null) {
            const stopDuration = 4000; // 4 segundos para parar
            
            if(wheelStopTime === 0) {
              wheelStopTime = ts;
              stopStartTime = ts;
              startRotation = wheelRotation;
              
              // Calcula onde deve parar
              const targetIndex = WHEEL.indexOf(wheelTargetNumber);
              const anglePerNumber = 360 / 37;
              const numberInitialAngle = targetIndex * anglePerNumber;
              const targetPosition = 180; // 6 horas
              
              // Posi√ß√£o atual do n√∫mero
              const currentNumberPosition = ((numberInitialAngle + wheelRotation) % 360 + 360) % 360;
              
              // Quanto precisa girar para chegar a 180¬∞
              let angleToTarget = ((targetPosition - currentNumberPosition) + 360) % 360;
              
              // Adiciona pelo menos 2 voltas extras
              if(angleToTarget < 180) angleToTarget += 720;
              else angleToTarget += 360;
              
              targetRotation = wheelRotation + angleToTarget;
              
              console.log('üéØ Stopping calculation:');
              console.log('   Number:', wheelTargetNumber, '| Index:', targetIndex);
              console.log('   Number initial angle:', numberInitialAngle.toFixed(1), '¬∞');
              console.log('   Current wheel rotation:', wheelRotation.toFixed(1), '¬∞');
              console.log('   Current number position:', currentNumberPosition.toFixed(1), '¬∞');
              console.log('   Angle to 180¬∞:', angleToTarget.toFixed(1), '¬∞');
              console.log('   Target rotation:', targetRotation.toFixed(1), '¬∞');
            }
            
            const elapsed = ts - stopStartTime;
            const stopProgress = Math.min(elapsed / stopDuration, 1);
            
            if(stopProgress < 1) {
              // Easing suave (ease-out cubic)
              const eased = 1 - Math.pow(1 - stopProgress, 3);
              wheelRotation = startRotation + (targetRotation - startRotation) * eased;
            } else {
              // Parou - garante posi√ß√£o exata
              wheelRotation = targetRotation;
              wheelSpeed = 0;
              isSpinning = false;
              
              // Verifica posi√ß√£o final
              const targetIndex = WHEEL.indexOf(wheelTargetNumber);
              const anglePerNumber = 360 / 37;
              const numberInitialAngle = targetIndex * anglePerNumber;
              const finalNumberPosition = ((numberInitialAngle + wheelRotation) % 360 + 360) % 360;
              
              console.log('');
              console.log('‚úÖ WHEEL STOPPED!');
              console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
              console.log('   üéØ Number:', wheelTargetNumber);
              console.log('   üìç Final position:', finalNumberPosition.toFixed(1), '¬∞ (should be 180¬∞)');
              console.log('   üé° Total rotation:', wheelRotation.toFixed(1), '¬∞');
              console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
              console.log('');
              
              highlightWinningNumber(wheelTargetNumber);
              playTick();
            }
          } else {
            // Girando em velocidade constante
            wheelRotation += wheelSpeed * dt;
          }
          
          wheel.style.transform = `rotate(${wheelRotation}deg)`;
          wheelRAF = requestAnimationFrame(tick);
        }
        
        wheelRAF = requestAnimationFrame(tick);
      }
      
      // Recebe o n√∫mero vencedor e agenda a parada
      function stopWheelAt(targetNumber) {
        if(!isSpinning) {
          console.warn('‚ö†Ô∏è Wheel is not spinning!');
          return;
        }
        
        if(wheelTargetNumber !== null) {
          console.warn('‚ö†Ô∏è Target already set!');
          return;
        }
        
        wheelTargetNumber = targetNumber;
        
        console.log('üéØ Received target number:', targetNumber);
        console.log('   Current rotation:', wheelRotation.toFixed(1), '¬∞');
        console.log('   Calculating stop position...');
        
        // Calcula delta de rota√ß√£o para sincronizar a bolinha
        const currentRot = wheelRotation;
        const targetIndex = WHEEL.indexOf(targetNumber);
        const anglePerNumber = 360 / 37;
        const numberInitialAngle = targetIndex * anglePerNumber;
        const targetPosition = 180; // 6 horas
        const currentNumberPosition = ((numberInitialAngle + currentRot) % 360 + 360) % 360;
        let angleToTarget = ((targetPosition - currentNumberPosition) + 360) % 360;
        
        // Adiciona pelo menos 2 voltas
        if(angleToTarget < 180) angleToTarget += 720;
        else angleToTarget += 360;
        
        const wheelDelta = angleToTarget;
        
        // Sincroniza bolinha (4 segundos como a wheel)
        syncBallToWheel(wheelDelta, 4000, targetNumber);
      }

      function highlightWinningNumber(num) {
        document.querySelectorAll('.num.active').forEach(el => el.classList.remove('active'));
        const winningCell = document.querySelector(`.num[data-number="${num}"]`);
        if(winningCell) {
          winningCell.classList.add('active');
        }
      }

      function stopWheel() {
        isSpinning = false;
        cancelAnimationFrame(wheelRAF);
        cancelAnimationFrame(ballRAF);
        wheelRAF = 0;
        ballRAF = 0;
        wheelSpeed = 0;
        wheelTargetNumber = null;
        wheelStopTime = 0;
        wheelStartStopTime = 0;
        ballOmega = 0;
        ball.style.opacity = '0';
      }

      async function spin() {
        if(!ws||ws.readyState!==1){
          console.log('‚ö†Ô∏è WebSocket not connected, reconnecting...');
          connect();
          return;
        }
        if(spinning) return;
        
        let total=0; 
        bets.forEach(v=>total+=v);
        
        if(total === 0) {
          alert('Please place a bet first');
          return;
        }
        
        if(total>bal){
          alert('Insufficient balance');
          return;
        }
        
        spinning=true;
        currentBetAmount = total; // Salva valor da aposta
        
        // Esconde overlay de resultado anterior
        const overlay = $('resultOverlay');
        if(overlay) overlay.classList.remove('show');
        
        // Limpa destaques anteriores
        document.querySelectorAll('.num.active').forEach(el => el.classList.remove('active'));
        
        // INICIA ROTA√á√ÉO CONT√çNUA (sem saber o n√∫mero ainda)
        startWheelSpin();
        
        updateUI();
        
        const betData = {
          eventType: 'BET',
          userId: pid,
          gameId: 'roulette-v1',
          amount: total,
          bets: Object.fromEntries(bets),
          timestamp: new Date().toISOString()
        };
        
        console.log('üì§ Sending bet:', betData);
        ws.send(JSON.stringify(betData));
        
        // N√ÉO desconta mais aqui - backend faz isso e envia novo saldo no ACK
        // O saldo ser√° atualizado quando receber a mensagem RECEIVED com newBalance
        updateUI();
        
        // Timeout de seguran√ßa (30 segundos)
        if(spinTimeout) clearTimeout(spinTimeout);
        spinTimeout = setTimeout(() => {
          if(spinning) {
            console.error('‚è±Ô∏è Timeout waiting for result');
            spinning = false;
            updateUI();
            alert('Request timeout. Please try again.');
          }
        }, 30000);
      }

      function result(m) {
        if(!spinning) {
          console.log('‚ö†Ô∏è Received result but not spinning:', m);
          return;
        }
        
        // Limpa timeout de seguran√ßa
        if(spinTimeout) {
          clearTimeout(spinTimeout);
          spinTimeout = null;
        }
        
        // Debug: mostra estrutura completa da mensagem
        console.log('üì¶ Raw result message:', JSON.stringify(m, null, 2));
        
        // Extrai o n√∫mero ganhador
        let n = m.number ?? m.resultNumber ?? m.winningNumber;
        
        // Se n√£o tem n√∫mero mas tem a cor (result: "BLACK", "RED", "GREEN")
        if((n === undefined || n === null) && m.result) {
          console.warn('‚ö†Ô∏è Backend sent color instead of number. Generating random number for color:', m.result);
          n = generateNumberFromColor(m.result);
          console.log('üé≤ Generated number:', n, 'for color:', m.result);
        }
        
        // Converte para n√∫mero se vier como string
        if(typeof n === 'string') {
          n = parseInt(n, 10);
        }
        
        // Se ainda for undefined/null, usa n√∫mero aleat√≥rio
        if(n === undefined || n === null || isNaN(n)) {
          console.warn('‚ö†Ô∏è No valid number found, generating random number');
          n = WHEEL[Math.floor(Math.random() * WHEEL.length)];
        }
        
        console.log('üé≤ Processing result - Winning Number:', n, 'Win:', m.win, 'New Balance:', m.newBalance);
        
        // Envia comando para parar no n√∫mero vencedor
        stopWheelAt(n);
        
        // Aguarda 5 segundos (4s de desacelera√ß√£o + 1s de margem) antes de finalizar
        setTimeout(() => {
          finish(n, m.win, m.newBalance, m);
        }, 5000);
      }
      
      function generateNumberFromColor(color) {
        // Gera n√∫mero aleat√≥rio baseado na cor
        if(color === 'GREEN') {
          return 0;
        } else if(color === 'RED') {
          const redNumbers = [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];
          return redNumbers[Math.floor(Math.random() * redNumbers.length)];
        } else if(color === 'BLACK') {
          const blackNumbers = [2,4,6,8,10,11,13,15,17,20,22,24,26,28,29,31,33,35];
          return blackNumbers[Math.floor(Math.random() * blackNumbers.length)];
        }
        return 0; // fallback
      }
      
      function showResultOverlay(isWin) {
        const overlay = $('resultOverlay');
        const text = $('resultText');
        
        if(!overlay || !text) return;
        
        // Define texto e classe
        text.textContent = isWin ? 'WIN' : 'LOSE';
        text.className = 'result-text ' + (isWin ? 'win' : 'lose');
        
        console.log(isWin ? 'üéâ Showing WIN overlay' : '‚ùå Showing LOSE overlay');
        
        // Mostra overlay com anima√ß√£o
        overlay.classList.add('show');
        
        // Esconde ap√≥s 3 segundos
        setTimeout(() => {
          overlay.classList.remove('show');
          console.log('Hiding result overlay');
        }, 3000);
      }

      function finish(n, win, nb, backendData) {
        console.log('');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üèÅ FINISH CALLED - Starting round completion');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('   Number:', n);
        console.log('   Win:', win);
        console.log('   New Balance:', nb);
        console.log('   Current Bet Amount:', currentBetAmount);
        console.log('   Backend Data:', backendData);
        console.log('');
        
        if(!n && n !== 0) {
          console.error('‚ùå ERROR: Invalid number received!');
          return;
        }
        
        if(!backendData) {
          console.error('‚ùå ERROR: Backend data not provided!');
          return;
        }
        
        spinning = false;
        
        // Atualiza balance - SEMPRE usa o que vem do backend
        if(backendData.newBalance !== undefined && backendData.newBalance !== null) {
          bal = Number(backendData.newBalance);
          console.log('üí∞ Balance updated from backend:', bal);
        } else {
          console.warn('‚ö†Ô∏è Backend did not send newBalance, keeping current balance:', bal);
        }
        
        // Mostra WIN ou LOSE no centro da roleta
        showResultOverlay(win);
        
        updateUI();
        
        // Envia atualiza√ß√£o de saldo para todas as sess√µes
        if(ws && ws.readyState === 1) {
          const balanceUpdate = {
            eventType: 'BALANCE_UPDATED',
            userId: pid,
            balance: bal,
            timestamp: new Date().toISOString()
          };
          ws.send(JSON.stringify(balanceUpdate));
          console.log('üí∞ Balance update sent to server:', bal);
        }
        
        // Destaca n√∫mero vencedor na mesa
        console.log('üîç Looking for cell with number:', n);
        const el = document.querySelector(`.cell[data-k="number"][data-v="${n}"]`);
        if(el) {
          console.log('‚úÖ Found cell for number', n, '- highlighting on table');
          
          // Adiciona destaque (sem scroll)
          setTimeout(() => {
            el.classList.add('win-anim');
          }, 100);
        } else {
          console.error('‚ùå Cell not found for number:', n);
        }
        
        // Adiciona ao hist√≥rico (Recent Numbers)
        const slots = document.querySelectorAll('.coin-slot:not(.filled)');
        if(slots.length > 0) {
          const slot = slots[0];
          slot.textContent = n;
          slot.classList.add('filled');
          if(n === 0) slot.classList.add('coin-green');
          else if(REDS.has(n)) slot.classList.add('coin-red');
          else slot.classList.add('coin-black');
          console.log('üìä Added to history:', n);
        }
        
        // Envia resultado para todos os jogadores via broadcast
        console.log('üìä Creating bet result data...');
        console.log('   currentBetAmount:', currentBetAmount);
        console.log('   Backend data:', backendData);
        
        if(!currentBetAmount || currentBetAmount === 0) {
          console.error('‚ùå ERROR: currentBetAmount is 0! Cannot log bet.');
          console.error('   This means the bet amount was not saved correctly.');
        }
        
        const betResultData = {
          eventType: 'BET_RESULT',
          userId: pid,
          number: n,
          betAmount: currentBetAmount,
          win: win,
          winAmount: backendData.winAmount || 0,    // Total payout do backend
          netWin: backendData.netWin || 0,           // Lucro l√≠quido do backend
          timestamp: new Date().toISOString()
        };
        
        console.log('üéØ Bet result data created:', betResultData);
        
        // Adiciona ao log local
        console.log('üìù Calling addBetToLog...');
        addBetToLog(betResultData);
        console.log('‚úÖ addBetToLog completed');
        
        // Envia para todos via WebSocket
        if(ws && ws.readyState === 1) {
          console.log('üì§ Broadcasting bet result to all players:', betResultData);
          ws.send(JSON.stringify(betResultData));
          console.log('‚úÖ Broadcast sent successfully');
        } else {
          console.error('‚ùå WebSocket not connected, cannot broadcast');
        }
        
        // üé∞ AUTO MODE: Mant√©m apostas e agenda pr√≥ximo spin
        if(autoMode) {
          console.log('ü§ñ AUTO MODE ACTIVE: Keeping bets for next spin');
          
          // Verifica se ainda tem apostas
          let total = 0;
          bets.forEach(v => total += v);
          
          if(total === 0) {
            console.log('‚ö†Ô∏è AUTO MODE: No bets - stopping');
            autoMode = false;
            $('btnManual').classList.add('active');
            $('btnAuto').classList.remove('active');
            alert('Auto mode stopped: No bets on table');
          } else if(total > bal) {
            console.log('‚ö†Ô∏è AUTO MODE: Insufficient balance - stopping');
            autoMode = false;
            $('btnManual').classList.add('active');
            $('btnAuto').classList.remove('active');
            alert('Auto mode stopped: Insufficient balance');
          } else {
            console.log(`üé∞ AUTO MODE: Scheduling next spin in ${autoSpinDelay}ms with bet of ${total}`);
            
            // Agenda pr√≥ximo spin
            if(autoSpinTimeout) clearTimeout(autoSpinTimeout);
            autoSpinTimeout = setTimeout(() => {
              console.log('üé∞ AUTO MODE: Spinning...');
              spin();
            }, autoSpinDelay);
          }
          
          updateUI();
        } else {
          // MODO MANUAL: Limpa apostas ap√≥s cada rodada
          console.log('üéÆ MANUAL MODE: Clearing bets');
          bets.clear();
          currentBetAmount = 0;
          updateUI();
        }
        
        console.log('‚úÖ Round finished - Number:', n, 'Balance:', bal);
      }

      function connect() {
        if(ws)ws.close(); $('connText').textContent='Connecting...';
        ws=new WebSocket(`${WS_URL}?token=${pid}`);
        
        ws.onopen=()=>{ 
          $('dot').style.background='#22c55e'; 
          $('connText').textContent='Online';
          console.log('‚úÖ WebSocket connected | userId:', pid);
          console.log('üí¨ Chat ready - You can now send/receive messages');
          
          // Envia avatar para o servidor (se tiver avatar selecionado)
          if(selectedAvatar) {
            const avatarUpdate = {
              eventType: 'SET_AVATAR',
              userId: pid,
              avatar: selectedAvatar
            };
            ws.send(JSON.stringify(avatarUpdate));
            console.log('üì§ Avatar sent to server on connect:', selectedAvatar);
          } else {
            console.log('‚ÑπÔ∏è No avatar selected - will show initial only');
          }
          
          // N√ÉO envia saldo ao conectar - backend j√° cria o saldo inicial ($10,000)
          // e envia via BALANCE_UPDATE. S√≥ enviamos BALANCE_UPDATED quando o saldo
          // muda no frontend (ap√≥s apostas/ganhos).
          console.log('‚è≥ Waiting for initial balance from server...');
          
          // Lista de jogadores √© recebida automaticamente via broadcast
          // N√£o precisa solicitar explicitamente
        };
        
        ws.onclose=(event)=>{ 
          const timestamp = new Date().toLocaleTimeString();
          console.log(`‚ùå [${timestamp}] WebSocket CLOSED`);
          console.log(`   ‚Ü≥ Code: ${event.code} | Reason: ${event.reason || 'none'} | Clean: ${event.wasClean}`);
          console.log(`   ‚Ü≥ Current user: ${pid}`);
          $('dot').style.background='#ef4444'; 
          $('connText').textContent='Offline';
        };
        
        ws.onerror=(err)=>{ 
          console.error('WebSocket error:', err);
          $('dot').style.background='#ef4444'; 
          $('connText').textContent='Error';
        };
        
        ws.onmessage=e=>{ 
          try {
            const msg = JSON.parse(e.data);
            console.log('');
            console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
            console.log('‚ïë   üì® WEBSOCKET MESSAGE RECEIVED               ‚ïë');
            console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
            console.log('üì® RAW:', e.data);
            console.log('üì® PARSED:', msg);
            console.log('üì® Event Type:', msg.eventType);
            console.log('üì® Current local balance (bal):', bal);
            console.log('');
            
            // ACK de recebimento da aposta
            if(msg.status === 'RECEIVED') {
              console.log('‚úÖ Bet received by server');
              // Atualiza saldo se veio do backend
              if(msg.newBalance !== undefined) {
                bal = msg.newBalance;
                console.log('üí∞ Balance updated after bet:', bal);
                updateUI();
              }
              return;
            }
            
            // Erro de saldo insuficiente
            if(msg.status === 'ERROR' && msg.error === 'INSUFFICIENT_BALANCE') {
              console.error('‚ùå Insufficient balance!');
              console.error('   Current:', msg.currentBalance, 'Required:', msg.requiredAmount);
              alert(`Saldo insuficiente!\n\nSaldo atual: ${fmt(msg.currentBalance)}\nValor necess√°rio: ${fmt(msg.requiredAmount)}`);
              spinning = false;
              updateUI();
              return;
            }
            
            // Atualiza√ß√£o de saldo (ao conectar ou ap√≥s resultado)
            if(msg.eventType === 'BALANCE_UPDATE') {
              console.log('');
              console.log('üí∞üí∞üí∞ BALANCE_UPDATE RECEIVED! üí∞üí∞üí∞');
              console.log('   Old balance:', bal);
              console.log('   New balance from server:', msg.balance);
              bal = msg.balance;
              console.log('   Updated local balance (bal):', bal);
              console.log('');
              updateUI();
              return;
            }
            
            // Atualiza√ß√£o de saldo de outro jogador (broadcast)
            if(msg.eventType === 'BALANCE_UPDATED') {
              console.log('üí∞ Balance update broadcast from:', msg.userId, '| New balance:', msg.balance);
              // O backend deve rebroadcastear ACTIVE_PLAYERS_UPDATE com os saldos atualizados
              // N√£o fazemos nada aqui, s√≥ logamos
              return;
            }
            
          // Active Players Update
          if(msg.eventType === 'ACTIVE_PLAYERS_UPDATE') {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`üîî [${timestamp}] WS Message: ACTIVE_PLAYERS_UPDATE`);
            console.log(`   ‚Ü≥ Active count: ${msg.activeCount} | Players: ${msg.players?.length || 0}`);
            handleActivePlayersUpdate(msg);
            return;
          }
            
            // Chat Message
            if(msg.eventType === 'CHAT_MESSAGE') {
              console.log('üí¨ Chat message received:', msg);
              handleChatMessage(msg);
              return;
            }
            
            // Bet Result Broadcast (de outros jogadores)
            if(msg.eventType === 'BET_RESULT') {
              console.log('üé≤ Bet result broadcast received:', msg);
              console.log('   From:', msg.userId, '| My ID:', pid, '| Same user?', msg.userId === pid);
              console.log('   Win:', msg.win, '| Amount:', msg.winAmount);
              
              // S√≥ adiciona se n√£o for nossa pr√≥pria aposta (para evitar duplica√ß√£o)
              if(msg.userId !== pid) {
                console.log('   ‚úÖ Adding to log (other player)');
                addBetToLog(msg);
              } else {
                console.log('   ‚ö†Ô∏è Skipping (own broadcast, already in log)');
              }
              return;
            }
            
            // Resultado do jogo - tenta v√°rias condi√ß√µes poss√≠veis
            const isResult = msg.eventType === 'ROUND_RESULT' || 
                            msg.type === 'GAME_RESULT' || 
                            msg.number !== undefined ||
                            msg.resultNumber !== undefined ||
                            msg.winningNumber !== undefined;
            
            if(isResult) {
              console.log('üé∞ Game result detected:', msg);
              result(msg);
            } else {
              console.log('‚ÑπÔ∏è Unknown message type:', msg);
            }
          } catch(x) {
            console.error('‚ùå Error parsing message:', x);
            console.error('Raw data:', e.data);
          }
        };
      }

      /* ====================================================
      * BETS LOG - Hist√≥rico de Apostas
      * ==================================================== */
      function addBetToLog(betData) {
        console.log('');
        console.log('‚ïê‚ïê‚ïê addBetToLog CALLED ‚ïê‚ïê‚ïê');
        console.log('Full bet data:', betData);
        console.log('   userId:', betData.userId);
        console.log('   number:', betData.number);
        console.log('   betAmount:', betData.betAmount);
        console.log('   win:', betData.win);
        console.log('   winAmount:', betData.winAmount);
        console.log('   netWin:', betData.netWin);
        console.log('   isMyBet:', betData.userId === pid);
        
        // Valida dados m√≠nimos
        if(!betData.userId || betData.number === undefined) {
          console.error('‚ùå ERROR: Invalid bet data! Missing userId or number.');
          return;
        }
        
        // Adiciona ao array (mais recente primeiro)
        console.log('Adding to betsLog array...');
        betsLog.unshift(betData);
        console.log('‚úÖ Added! Total bets in log:', betsLog.length);
        
        // Limita a 100 entradas
        if(betsLog.length > 100) {
          console.log('Trimming log to 100 entries');
          betsLog.pop();
        }
        
        // Atualiza a UI
        console.log('Calling renderBetsLog...');
        renderBetsLog();
        console.log('‚úÖ renderBetsLog completed');
        
        // Mostra indicador LIVE
        const liveDot = $('liveDot');
        if(liveDot) {
          liveDot.style.display = 'inline';
          setTimeout(() => {
            liveDot.style.display = 'none';
          }, 3000);
        }
        
        // Notifica√ß√£o de vit√≥ria de outros jogadores
        if(betData.userId !== pid && betData.win) {
          const displayName = extractUsername(betData.userId);
          console.log('üéâ ' + displayName + ' won ' + fmt(betData.winAmount) + ' on number ' + betData.number + '!');
        }
        
        console.log('‚ïê‚ïê‚ïê addBetToLog COMPLETED ‚ïê‚ïê‚ïê');
        console.log('');
      }
      
      let currentFilter = 'all'; // Armazena filtro atual
      
      function renderBetsLog(filter) {
        console.log('');
        console.log('‚ïê‚ïê‚ïê renderBetsLog CALLED ‚ïê‚ïê‚ïê');
        
        // Se n√£o passar filtro, usa o atual
        if(filter !== undefined) {
          currentFilter = filter;
        } else {
          filter = currentFilter;
        }
        
        console.log('Filter:', filter);
        console.log('Total bets in array:', betsLog.length);
        
        const container = $('betsLog');
        if(!container) {
          console.error('‚ùå ERROR: betsLog container not found in DOM!');
          return;
        }
        
        console.log('‚úÖ Container found:', container);
        
        // Filtra apostas
        let filtered = betsLog;
        if(filter === 'wins') {
          filtered = betsLog.filter(b => b.win);
          console.log('   Filtered to wins only:', filtered.length);
        } else if(filter === 'my') {
          filtered = betsLog.filter(b => b.userId === pid);
          console.log('   Filtered to my bets only:', filtered.length);
        }
        
        console.log('   Rendering', filtered.length, 'bets');
        
        // Debug: mostra primeiras 3 apostas
        if(filtered.length > 0) {
          console.log('   First bet:', {
            userId: filtered[0].userId,
            number: filtered[0].number,
            win: filtered[0].win,
            winAmount: filtered[0].winAmount
          });
        }
        
        // Atualiza contador
        $('totalBets').textContent = `${betsLog.length} bet${betsLog.length !== 1 ? 's' : ''}`;
        
        // Renderiza
        container.innerHTML = '';
        
        if(filtered.length === 0) {
          container.innerHTML = '<div style="padding:20px;text-align:center;color:#555;font-size:12px;">No bets yet. Start playing!</div>';
          return;
        }
        
        filtered.forEach((bet, idx) => {
          const row = document.createElement('div');
          row.className = 'leaderboard-row';
          
          // Formata hor√°rio
          const time = formatChatTime(bet.timestamp);
          
          // Usa netWin do backend (se dispon√≠vel) ou calcula
          const profitLoss = bet.netWin !== undefined ? bet.netWin : 
                            (bet.win ? bet.winAmount - bet.betAmount : -bet.betAmount);
          const profitColor = profitLoss > 0 ? '#22c55e' : '#ef4444';
          const profitSign = profitLoss >= 0 ? '+' : '';
          
          // Destaque para vit√≥rias grandes (acima de $500)
          if(bet.win && profitLoss > 500) {
            row.classList.add('big-win-row');
          }
          // Destaque para apostas recentes (primeiras 3)
          else if(idx < 3) {
            row.style.background = 'rgba(245,158,11,0.05)';
          }
          
          // Cor do n√∫mero
          let numColor = '#15803d'; // green
          if(bet.number !== 0) {
            numColor = REDS.has(bet.number) ? '#dc2626' : '#e5e7eb';
          }
          
          // Extrai username para display (remove sessionId)
          const displayName = extractUsername(bet.userId);
          
          // Badge "YOU" para suas apostas
          const youBadge = bet.userId === pid ? '<span style="background:var(--accent);color:#000;font-size:8px;padding:2px 6px;border-radius:4px;margin-left:6px;font-weight:800;">YOU</span>' : '';
          
          row.innerHTML = `
            <div class="lb-user" style="color:${bet.userId === pid ? 'var(--accent)' : '#e5e7eb'}">${displayName}${youBadge}</div>
            <div style="color:#9ca3af;font-size:10px;">${time}</div>
            <div style="color:${numColor};font-weight:700;font-size:14px;">${bet.number}</div>
            <div style="color:#9ca3af;font-family:monospace;font-size:11px;">${fmt(bet.betAmount)}</div>
            <div style="color:${bet.win ? '#22c55e' : '#ef4444'};font-weight:700;font-size:11px;text-transform:uppercase;">${bet.win ? '‚úì WIN' : '‚úó LOSS'}</div>
            <div style="color:${profitColor};font-weight:700;font-family:monospace;font-size:12px;">${profitSign}${fmt(Math.abs(profitLoss))}</div>
          `;
          
          container.appendChild(row);
          console.log('   ‚úÖ Row added to DOM:', bet.userId, 'number:', bet.number);
        });
        
        console.log('‚úÖ All rows rendered');
        console.log('‚ïê‚ïê‚ïê renderBetsLog COMPLETED ‚ïê‚ïê‚ïê');
        console.log('');
      }
      
      /* INIT */
      $('btnAction').onclick=spin;
      $('btnReset').onclick=()=>{
        // N√£o pode mais resetar saldo (controlado pelo backend)
        // Apenas limpa apostas
        bets.clear();
        updateUI();
        alert('Balance is controlled by the server.\nReconnect to get a new $10,000 balance.');
      };
      $('btnClear').onclick=()=>{
        bets.clear();
        updateUI();
        
        // Se est√° em AUTO mode, desativa
        if(autoMode) {
          autoMode = false;
          $('btnManual').classList.add('active');
          $('btnAuto').classList.remove('active');
          
          // Cancela auto-spin agendado
          if(autoSpinTimeout) {
            clearTimeout(autoSpinTimeout);
            autoSpinTimeout = null;
          }
          
          console.log('üõë AUTO MODE: Stopped (bets cleared)');
        }
      };
      $('btnConnect').onclick=connect;
      $('betInput').oninput=e=>chip=Number(e.target.value);
      
      // Settings button
      $('settingsBtn').onclick=()=>window.openModal('settingsModal');
      
      // Toggle Manual/Auto
      $('btnManual').onclick=()=>{ 
        autoMode=false; 
        $('btnManual').classList.add('active'); 
        $('btnAuto').classList.remove('active');
        
        // Cancela auto-spin agendado
        if(autoSpinTimeout) {
          clearTimeout(autoSpinTimeout);
          autoSpinTimeout = null;
          console.log('üõë AUTO MODE: Cancelled scheduled spin');
        }
      };
      
      $('btnAuto').onclick=()=>{ 
        // Verifica se tem apostas na mesa
        let total = 0;
        bets.forEach(v => total += v);
        
        if(total === 0) {
          alert('Please place bets before activating Auto mode');
          return;
        }
        
        if(total > bal) {
          alert('Insufficient balance for current bets');
          return;
        }
        
        autoMode=true; 
        $('btnAuto').classList.add('active'); 
        $('btnManual').classList.remove('active');
        console.log('ü§ñ AUTO MODE ACTIVATED - Bets will repeat automatically');
        
        // Se n√£o est√° girando, inicia o primeiro spin
        if(!spinning) {
          console.log('üé∞ AUTO MODE: Starting first spin...');
          spin();
        }
      };
      
      // Chip selection
      document.querySelectorAll('.chip-select').forEach(c=>{
        c.onclick=()=>{
          if(c.id==='btnClear')return;
          document.querySelectorAll('.chip-select').forEach(x=>x.classList.remove('active'));
          c.classList.add('active'); 
          chip=Number(c.dataset.val); 
          $('betInput').value=chip;
        };
      });

      /* ====================================================
      * ACTIVE PLAYERS - Via WebSocket (Sem CORS!)
      * ==================================================== */
      function handleActivePlayersUpdate(msg) {
        const timestamp = new Date().toLocaleTimeString();
        console.log('');
        console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
        console.log('‚ïë    ACTIVE_PLAYERS_UPDATE RECEIVED              ‚ïë');
        console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
        console.log('üì¶ Full message:', JSON.stringify(msg, null, 2));
        
        const activeCount = msg.activeCount || msg.count || 0;
        const players = msg.players || msg.activePlayers || [];
        
        console.log(`üë• Active count: ${activeCount} | Players in array: ${players.length}`);
        console.log('üìã Player IDs:', players.map(p => p.userId).join(', '));
        
        // Verifica se algum player tem balance
        const playersWithBalance = players.filter(p => p.balance !== undefined && p.balance !== null);
        console.log('');
        console.log('üí∞ BALANCE CHECK IN ACTIVE_PLAYERS_UPDATE:');
        console.log('   Players with balance field:', playersWithBalance.length, '/', players.length);
        
        if(playersWithBalance.length > 0) {
          console.log('   ‚úÖ SUCCESS! Sample balances:');
          playersWithBalance.slice(0, 5).forEach(p => {
            console.log(`      ‚Ä¢ ${p.userId}: $${p.balance}`);
          });
        } else {
          console.error('');
          console.error('‚ùå‚ùå‚ùå ERROR: NO PLAYERS HAVE BALANCE! ‚ùå‚ùå‚ùå');
          console.error('');
          console.error('üî• Backend is NOT including balance in ACTIVE_PLAYERS_UPDATE!');
          console.error('üî• Check if ws-gw deployed with correct XML!');
          console.error('');
          console.error('Expected structure:');
          console.error('{');
          console.error('  "players": [');
          console.error('    {');
          console.error('      "userId": "...",');
          console.error('      "avatar": "...",');
          console.error('      "balance": 10000  ‚Üê MISSING!');
          console.error('    }');
          console.error('  ]');
          console.error('}');
          console.error('');
        }
        
        console.log('üîç Current local balance (bal):', bal);
        console.log('');
        
        // Atualiza contador de viewers no chat
        $('chatViewers').textContent = `${activeCount} üëÅ`;
        
        if(players.length > 0) {
          console.log(`‚úÖ [${timestamp}] Updating UI with ${players.length} players`);
          updatePlayersList(players);
          $('playerCount').textContent = activeCount;
        } else {
          console.log(`‚ö†Ô∏è [${timestamp}] No players online - clearing list`);
          $('playerList').innerHTML = '<div style="padding:20px;text-align:center;color:#555;font-size:12px;">No players online</div>';
          $('playerCount').textContent = '0';
        }
        
        console.log(`‚úîÔ∏è [${timestamp}] handleActivePlayersUpdate completed`);
      }
      
      // requestActivePlayersUpdate() removida - n√£o √© mais necess√°ria
      // O broadcast autom√°tico mant√©m todos sincronizados
      
      function updatePlayersList(players) {
        const pl = $('playerList');
        pl.innerHTML = ''; // Limpa lista atual
        
        console.log('üé® Rendering', players.length, 'players');
        console.log('üìä Players data:', JSON.stringify(players, null, 2));
        
        players.forEach(p => {
          const d = document.createElement('div');
          d.className = 'player-item';
          
          const displayName = extractUsername(p.userId); // Mostra apenas username, sem sessionId
          
          // Debug detalhado do balance
          console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
          console.log(`üë§ Player: ${p.userId}`);
          console.log(`   Display: ${displayName}`);
          console.log(`   Balance (raw):`, p.balance);
          console.log(`   Balance (type):`, typeof p.balance);
          console.log(`   Balance (undefined?):`, p.balance === undefined);
          console.log(`   Avatar:`, p.avatar || 'none');
          console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
          
          // Usa a mesma fun√ß√£o de cor do chat para consist√™ncia
          const userColor = getUserColor(p.userId);
          
          // Determina conte√∫do do avatar
          let avatarContent;
          if(p.avatar && p.avatar.startsWith('http')) {
            // √â uma URL de imagem
            avatarContent = `<img src="${p.avatar}" alt="Avatar" style="width:100%;height:100%;object-fit:cover;border-radius:12px;">`;
          } else if(p.avatar) {
            // √â emoji ou texto
            avatarContent = p.avatar;
          } else {
            // Fallback: primeira letra do displayName
            avatarContent = (displayName || 'U')[0].toUpperCase();
          }
          
          // Mostra saldo do jogador (se dispon√≠vel)
          // IMPORTANTE: Backend precisa incluir o campo "balance" em cada player do ACTIVE_PLAYERS_UPDATE
          let playerBalance = '‚Äî';
          let balanceColor = '#666';
          
          if(p.balance !== undefined && p.balance !== null) {
            // Backend enviou balance - usa ele
            playerBalance = fmt(p.balance);
            balanceColor = p.balance > 0 ? '#cfb53b' : '#ef4444';
            console.log(`üí∞ Using backend balance: ${playerBalance}`);
          } else {
            // Backend n√£o enviou balance
            if(p.userId === pid) {
              // √â o pr√≥prio jogador - usa saldo local se j√° foi recebido
              if(bal > 0) {
                playerBalance = fmt(bal);
                balanceColor = '#cfb53b';
                console.log(`‚ÑπÔ∏è Using local balance for self: ${playerBalance}`);
              } else {
                // Ainda aguardando BALANCE_UPDATE do backend
                playerBalance = '‚Äî';
                balanceColor = '#666';
                console.log(`‚è≥ Waiting for initial balance from server...`);
              }
            } else {
              console.warn(`‚ö†Ô∏è No balance for player ${p.userId} - backend needs to include it`);
            }
          }
          
          console.log(`üí∞ Final balance display: ${playerBalance} | Color: ${balanceColor}`);
          
          d.innerHTML = `
            <div class="avatar" style="background:${userColor};color:#fff;${!p.avatar || !p.avatar.startsWith('http') ? 'font-size:14px;' : 'padding:2px;'}">
              ${avatarContent}
            </div>
            <div style="flex:1">
              <div class="p-name">${displayName}</div>
              <div style="color:#555;font-size:10px;">
                <span style="color:#22c55e;">‚óè </span>Online
              </div>
            </div>
            <div class="p-win" style="font-size:11px;color:${balanceColor};">${playerBalance}</div>
          `;
          
        pl.appendChild(d);
          console.log('  ‚úÖ Added player:', p.userId, '| avatar:', p.avatar);
        });
        
        console.log('‚úÖ Players list updated');
      }
      
      // Polling removido - broadcast autom√°tico funciona melhor!
      // Quando algu√©m conecta/desconecta, todos recebem atualiza√ß√£o automaticamente

      /* ====================================================
      * CHAT - Via WebSocket
      * ==================================================== */
      function handleChatMessage(msg) {
        console.log('üí¨ Processing chat message:', msg);
        
        const userId = msg.userId || 'Anonymous';
        const message = msg.message || '';
        const timestamp = msg.timestamp || new Date().toISOString();
        
        if(!message.trim()) {
          console.warn('‚ö†Ô∏è Empty message, ignoring');
          return;
        }
        
        addMessageToChat(userId, message, timestamp);
      }
      
      function addMessageToChat(userId, message, timestamp) {
        const chatBox = $('chatBox');
        
        // Cria elemento de mensagem
        const msgDiv = document.createElement('div');
        msgDiv.className = 'chat-row';
        
        // Formata hor√°rio (HH:MM am/pm)
        const time = formatChatTime(timestamp);
        
        // Extrai username para display (remove sessionId)
        const displayName = extractUsername(userId);
        
        // Cor consistente para cada usu√°rio
        const userColor = getUserColor(userId);
        
        msgDiv.innerHTML = `
          <div style="margin-bottom:4px">
            <span style="color:${userColor};font-weight:600">${escapeHtml(displayName)}</span>
            <span style="color:#555;font-size:9px;margin-left:6px">${time}</span>
          </div>
          <span style="color:#d1d5db">${escapeHtml(message)}</span>
        `;
        
        chatBox.appendChild(msgDiv);
        
        // Auto-scroll para √∫ltima mensagem
        chatBox.scrollTop = chatBox.scrollHeight;
        
        // Mostra indicador LIVE (s√≥ para mensagens de outros usu√°rios)
        if(userId !== pid) {
          const chatLiveDot = $('chatLiveDot');
          if(chatLiveDot) {
            chatLiveDot.style.display = 'inline';
            setTimeout(() => {
              chatLiveDot.style.display = 'none';
            }, 3000);
          }
        }
        
        console.log('‚úÖ Message added to chat:', userId, '-', message);
      }
      
      function sendChatMessage(message) {
        if(!ws || ws.readyState !== 1) {
          console.error('‚ùå WebSocket not connected');
          alert('Not connected to server');
          return;
        }
        
        if(!message || !message.trim()) {
          console.warn('‚ö†Ô∏è Empty message, not sending');
          return;
        }
        
        const chatData = {
          eventType: 'CHAT_MESSAGE',
          userId: pid,
          message: message.trim(),
          timestamp: new Date().toISOString()
        };
        
        console.log('üì§ Sending chat message:', chatData);
        ws.send(JSON.stringify(chatData));
      }
      
      function formatChatTime(timestamp) {
        try {
          const date = new Date(timestamp);
          let hours = date.getHours();
          const minutes = date.getMinutes();
          const ampm = hours >= 12 ? 'pm' : 'am';
          hours = hours % 12 || 12;
          const minutesStr = minutes.toString().padStart(2, '0');
          return `${hours}:${minutesStr} ${ampm}`;
        } catch(e) {
          return 'now';
        }
      }
      
      function getUserColor(userId) {
        // Gera cor consistente baseada no userId
        const hash = userId.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
        const colors = [
          '#60a5fa', // blue
          '#a78bfa', // purple
          '#34d399', // green
          '#fb923c', // orange
          '#f87171', // red
          '#fbbf24', // yellow
          '#4ade80', // light green
          '#c084fc', // light purple
        ];
        return colors[hash % colors.length];
      }
      
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
      
      function clearChatMessages() {
        const chatBox = $('chatBox');
        chatBox.innerHTML = '';
        console.log('üóëÔ∏è Chat cleared');
      }

      // Initialize coin slots
      function initCoinSlots() {
        const container = $('historyCoins');
        
        // Cria 10 slots vazios (sem n√∫meros de exemplo)
        for(let i=0; i<10; i++) {
          const slot = document.createElement('div');
          slot.className = 'coin-slot';
          container.appendChild(slot);
        }
      }
      
      /* ====================================================
      * MODALS - Avatar & Settings
      * ==================================================== */
      window.openModal = function(modalId) {
        const modal = $(modalId);
        if(modal) {
          modal.classList.add('show');
          
          // Se for modal de avatar, renderiza os avatares e preenche username
          if(modalId === 'avatarModal') {
            renderAvatars();
            const usernameInput = $('usernameInput');
            if(usernameInput) {
              usernameInput.value = username; // Mostra apenas username, sem sessionId
              usernameInput.focus();
              usernameInput.select();
            }
          }
          
          // Se for modal de settings, preenche os campos
          if(modalId === 'settingsModal') {
            $('wsUrlInput').value = WS_URL;
            $('apiUrlInput').value = API_URL;
            $('soundEnabledCheckbox').checked = soundEnabled;
            console.log('‚öôÔ∏è Opening settings - Current sound:', soundEnabled);
          }
        }
      }
      
      window.closeModal = function(modalId) {
        const modal = $(modalId);
        if(modal) {
          modal.classList.remove('show');
        }
      }
      
      // Fecha modal ao clicar fora
      document.addEventListener('click', (e) => {
        if(e.target.classList.contains('modal-overlay')) {
          e.target.classList.remove('show');
        }
      });
      
      // Renderiza grid de avatares
      function renderAvatars() {
        const grid = $('avatarGrid');
        grid.innerHTML = '';
        
        AVATARS.forEach(avatarUrl => {
          const div = document.createElement('div');
          div.className = 'avatar-option';
          if(avatarUrl === selectedAvatar) {
            div.classList.add('selected');
          }
          
          const img = document.createElement('img');
          img.src = avatarUrl;
          img.alt = 'Avatar';
          img.loading = 'lazy'; // Lazy loading para performance
          
          div.appendChild(img);
          div.onclick = () => selectAvatar(avatarUrl);
          grid.appendChild(div);
        });
      }
      
      // Seleciona avatar (apenas marca visualmente, n√£o salva ainda)
      function selectAvatar(avatar) {
        selectedAvatar = avatar;
        
        // Atualiza sele√ß√£o visual
        document.querySelectorAll('.avatar-option').forEach(el => {
          el.classList.remove('selected');
        });
        
        // Marca o avatar selecionado
        document.querySelectorAll('.avatar-option').forEach(el => {
          const img = el.querySelector('img');
          if(img && img.src === avatar) {
            el.classList.add('selected');
          }
        });
        
        console.log('üë§ Avatar selected (not saved yet):', avatar);
      }
      
      // Salva configura√ß√µes
      window.saveSettings = function(event) {
        event.preventDefault();
        
        const newWsUrl = $('wsUrlInput').value.trim();
        const newApiUrl = $('apiUrlInput').value.trim();
        const newSoundEnabled = $('soundEnabledCheckbox').checked;
        
        // Valida√ß√£o b√°sica
        if(!newWsUrl || !newWsUrl.startsWith('ws://') && !newWsUrl.startsWith('wss://')) {
          alert('Invalid WebSocket URL. Must start with ws:// or wss://');
          return;
        }
        
        // Salva no localStorage (converte boolean para string explicitamente)
        localStorage.setItem('wsUrl', newWsUrl);
        localStorage.setItem('apiUrl', newApiUrl);
        localStorage.setItem('soundEnabled', newSoundEnabled ? 'true' : 'false');
        
        // Atualiza vari√°veis
        WS_URL = newWsUrl;
        API_URL = newApiUrl;
        soundEnabled = newSoundEnabled;
        
        console.log('üíæ Saved to localStorage - soundEnabled:', localStorage.getItem('soundEnabled'), '| Variable:', soundEnabled);
        
        console.log('‚öôÔ∏è Settings saved:');
        console.log('   WS_URL:', WS_URL);
        console.log('   API_URL:', API_URL);
        console.log('   Sound Enabled:', soundEnabled);
        
        // Fecha modal
        window.closeModal('settingsModal');
        
        // Mensagem de confirma√ß√£o
        const soundStatus = soundEnabled ? 'Ativado' : 'Desativado';
        
        // Reconecta se estava conectado
        if(ws) {
          alert(`Settings saved!\n\nSom: ${soundStatus}\n\nReconnecting to new server...`);
          ws.close();
          setTimeout(() => {
            connect();
          }, 500);
        } else {
          alert(`Settings saved!\n\nSom: ${soundStatus}`);
        }
      }
      
      buildTable(); initWheel(); initCoinSlots(); updateUI();
      
      // Inicializa bolinha (escondida) no topo
      ball.style.opacity = '0';
      setBallAngle(-90);
      
      /* ====================================================
      * SAVE AVATAR AND USERNAME
      * ==================================================== */
      window.saveAvatarAndUsername = function() {
        const usernameInput = $('usernameInput');
        const newName = usernameInput ? usernameInput.value.trim() : username;
        
        // Valida√ß√£o do username
        if(!newName) {
          alert('Username cannot be empty');
          return;
        }
        
        // Remove caracteres especiais
        const sanitized = newName.replace(/[^a-zA-Z0-9_-]/g, '');
        
        if(sanitized.length < 3) {
          alert('Username must be at least 3 characters long (alphanumeric only)');
          return;
        }
        
        if(sanitized.length > 20) {
          alert('Username must be less than 20 characters');
          return;
        }
        
        // Verifica se algo mudou
        const usernameChanged = sanitized !== username;
        const avatarChanged = true; // Sempre considera que pode ter mudado
        
        // Atualiza username e regenera pid (apenas nesta aba/sess√£o)
        const oldUsername = username;
        username = sanitized;
        pid = username + '_' + sessionId; // Regenera pid com novo username
        // N√ÉO salva username no localStorage - cada aba √© independente
        
        // N√£o salva avatar no localStorage - cada aba √© independente
        
        // Atualiza UI local
        updateUI();
        
        console.log('üíæ Saved changes:');
        if(usernameChanged) console.log('   Username:', oldUsername, '‚Üí', username);
        if(avatarChanged) console.log('   Avatar:', selectedAvatar);
        console.log('   New full userId (backend):', pid);
        
        // Fecha modal
        window.closeModal('avatarModal');
        
        // Se mudou username, precisa reconectar
        if(usernameChanged) {
          setTimeout(() => {
            alert(`Profile updated!\n\nUsername: ${username}\n\nReconnecting...`);
            if(ws) {
              ws.close();
              setTimeout(() => connect(), 500);
            }
          }, 300);
        } else {
          // Apenas avatar mudou - envia para backend sem reconectar
          if(ws && ws.readyState === 1) {
            const avatarUpdate = {
              eventType: 'SET_AVATAR',
              userId: pid,
              avatar: selectedAvatar
            };
            ws.send(JSON.stringify(avatarUpdate));
            console.log('üì§ Avatar sent to server:', pid, selectedAvatar);
          }
          console.log('‚úÖ Avatar updated successfully');
        }
      }
      
      /* ====================================================
      * CHAT EVENT LISTENERS
      * ==================================================== */
      const chatInput = document.querySelector('.chat-input');
      const chatSendBtn = document.querySelector('.chat-extended button');
      
      // Enviar mensagem ao clicar no bot√£o
      if(chatSendBtn) {
        chatSendBtn.onclick = () => {
          const message = chatInput.value;
          if(message && message.trim()) {
            sendChatMessage(message);
            chatInput.value = '';
          }
        };
      }
      
      // Enviar mensagem ao pressionar Enter
      if(chatInput) {
        chatInput.onkeypress = (e) => {
          if(e.key === 'Enter') {
            const message = chatInput.value;
            if(message && message.trim()) {
              sendChatMessage(message);
              chatInput.value = '';
            }
          }
        };
      }
      
      // Limpa mensagens de exemplo e prepara chat para uso real
      clearChatMessages();
      
      console.log('üí¨ Chat initialized - Ready to send/receive messages');
      
      /* ====================================================
      * TABS - Filtros de Bets Log
      * ==================================================== */
      const tabs = document.querySelectorAll('.top-players-full .tab');
      tabs.forEach((tab, idx) => {
        tab.onclick = () => {
          // Remove active de todas
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          // Aplica filtro
          if(idx === 0) renderBetsLog('all');
          else if(idx === 1) renderBetsLog('wins');
          else if(idx === 2) renderBetsLog('my');
        };
      });
      
      // Inicializa log vazio
      renderBetsLog();
      
      // Desconex√£o expl√≠cita quando a aba/janela for fechada
      window.addEventListener('beforeunload', (e) => {
        const timestamp = new Date().toLocaleTimeString();
        console.log(`üö™ [${timestamp}] beforeunload - Closing WebSocket explicitly`);
        
        if(ws && ws.readyState === WebSocket.OPEN) {
          // Envia mensagem de desconex√£o (n√£o-bloqueante)
          try {
            const disconnectMsg = {
              eventType: 'DISCONNECT',
              userId: pid,
              timestamp: new Date().toISOString()
            };
            ws.send(JSON.stringify(disconnectMsg));
            console.log(`‚úÖ [${timestamp}] DISCONNECT message sent`);
          } catch(err) {
            console.error('Failed to send disconnect message:', err);
          }
          
          // Fecha o WebSocket imediatamente
          ws.close(1000, 'Tab closing');
          console.log(`üîå [${timestamp}] WebSocket closed`);
        }
      });
      
      connect();
    })();
    </script>

    <!-- MODAL: Avatar Selection -->
    <div class="modal-overlay" id="avatarModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">Choose Your Avatar</div>
          <button class="modal-close" onclick="closeModal('avatarModal')">√ó</button>
        </div>
        <div class="modal-body">
          <!-- Username Section -->
          <div class="settings-group" style="margin-bottom: 20px;">
            <label class="settings-label">Your Username</label>
            <input 
              type="text" 
              class="settings-input" 
              id="usernameInput" 
              placeholder="Enter your username"
              maxlength="20"
              style="text-align: center; font-size: 16px; font-weight: 600;"
            >
            <div class="settings-hint">3-20 characters, letters/numbers only</div>
          </div>
          
          <!-- Avatar Grid -->
          <label class="settings-label" style="margin-bottom: 12px; display: block;">Select Avatar</label>
          <div class="avatar-grid" id="avatarGrid">
            <!-- Avatares ser√£o adicionados via JS -->
          </div>
          
          <!-- Bot√µes de A√ß√£o -->
          <div class="settings-buttons" style="margin-top: 20px;">
            <button type="button" class="modal-btn modal-btn-secondary" onclick="closeModal('avatarModal')">Cancel</button>
            <button type="button" class="modal-btn modal-btn-primary" onclick="saveAvatarAndUsername()">Save Changes</button>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL: Settings -->
    <div class="modal-overlay" id="settingsModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">‚öôÔ∏è Settings</div>
          <button class="modal-close" onclick="closeModal('settingsModal')">√ó</button>
        </div>
        <div class="modal-body">
          <form id="settingsForm" onsubmit="saveSettings(event)">
            <div class="settings-group">
              <label class="settings-label">WebSocket URL</label>
              <input 
                type="text" 
                class="settings-input" 
                id="wsUrlInput" 
                placeholder="ws://localhost:8081/ws"
                required
              >
              <div class="settings-hint">URL do servidor WebSocket (ex: ws://your-app.cloudhub.io/ws)</div>
            </div>
            
            <div class="settings-group">
              <label class="settings-label">API URL (opcional)</label>
              <input 
                type="text" 
                class="settings-input" 
                id="apiUrlInput" 
                placeholder="http://localhost:8081/api"
              >
              <div class="settings-hint">URL da API REST (se necess√°rio)</div>
            </div>
            
            <div class="settings-group">
              <label class="settings-label" style="display:flex;align-items:center;gap:10px;cursor:pointer;">
              <input 
                type="checkbox" 
                id="soundEnabledCheckbox" 
                style="width:20px;height:20px;cursor:pointer;"
              >
              <span>Habilitar Sons</span>
            </label>
            <div class="settings-hint">Sons de tick durante a rota√ß√£o da roleta</div>
          </div>
          
          <div class="settings-buttons">
            <button type="button" class="modal-btn modal-btn-secondary" onclick="closeModal('settingsModal')">
              Cancel
            </button>
            <button type="submit" class="modal-btn modal-btn-primary">
              Save & Reconnect
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  </body>
  </html>